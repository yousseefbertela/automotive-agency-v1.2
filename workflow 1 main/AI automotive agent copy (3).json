{
  "name": "AI automotive agent copy",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1376,
        1552
      ],
      "id": "9b11ea26-45b7-402e-b941-1fd8eb3443f3",
      "name": "Telegram Trigger",
      "webhookId": "165c30b3-3402-467f-bf09-10fdb8b8fb1f",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('format AI output').item.json.scenario }}",
                    "rightValue": "vin",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "80e1b107-bf5d-4450-9fc8-eb2a4f7294fb"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4c1ca011-f477-49d1-89c8-b27b64bd438e",
                    "leftValue": "={{ $('format AI output').item.json.scenario }}",
                    "rightValue": "=part",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "714851c6-a2f6-45b8-a5d0-9693325fb5f6",
                    "leftValue": "={{ $('format AI output').item.json.scenario }}",
                    "rightValue": "finalize",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "88387875-218b-4c2e-b8b0-c3f0536e1a7e",
                    "leftValue": "={{ $('format AI output').item.json.scenario }}",
                    "rightValue": "kit",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3024,
        1392
      ],
      "id": "d56e9ef3-8ed0-4a9e-a01b-f768a2783105",
      "name": "Switch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a2d788ed-6fff-4793-833c-ff683de605b2",
              "leftValue": "={{ $('Telegram Trigger').item.json.message.photo[0].file_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        864,
        1440
      ],
      "id": "c2867247-2a4e-4b0b-87a7-789e82a340f4",
      "name": "If Photo?"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger').item.json.message.photo[0].file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1088,
        1344
      ],
      "id": "bb67ba24-8d18-4d45-920c-0264ed6a03a5",
      "name": "Download Picture",
      "webhookId": "ff86ad6b-00ef-4d15-babc-6a9068708fa7",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "78711434-7719-4798-a57b-09a08ffc9dec",
              "name": "userMessage",
              "value": "={{ $('Telegram Trigger').item.json.message.text }}",
              "type": "string"
            },
            {
              "id": "90bd0912-67b9-43c0-a95a-f070d3a1089e",
              "name": "sessionId",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1536,
        1536
      ],
      "id": "5086f133-7b07-42ad-9caf-aa444409b80e",
      "name": "Set Plain Text"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1760,
        1664
      ],
      "id": "eba89f99-7768-478a-809f-1ebf307153e8",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "oxxlOcTwmUo3iwru",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Set Plain Text').item.json.userMessage }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are an automotive AI assistant.\n\nYour job is to analyze each user input (text or OCR), detect the intent, and execute the correct tool STRICTLY according to the rules below.\n\nYou MUST ALWAYS respond in JSON format.\nYou MUST NEVER output anything outside JSON.\nYou MUST ALWAYS include Egyptian Arabic human-readable text.\nThe greeting, tone, and wording MUST be generated naturally by the AI (NOT hardcoded).\n\n==========================\nCRITICAL OUTPUT CONTRACT\n==========================\n\n- You MUST ALWAYS output ALL keys listed in the OUTPUT FORMAT for EACH item you output.\n- You MUST NEVER omit any key.\n- If a value does not apply, output an empty string \"\" OR empty array [] as defined.\n- NEVER output null.\n- VIN MUST ALWAYS be a string.\n- part_name must always be outputed in singular form despite what user enters.\n- NEVER output text before or after the JSON.\n- NEVER add explanations outside JSON.\n- The JSON structure of EACH item MUST NEVER change.\n- All keys MUST always exist in EACH item.\n- human_text MUST:\n  - be Egyptian Arabic\n  - be short and human\n  - describe an ONGOING or NEXT action\n  - clearly indicate the system is WAITING or ABOUT TO ACT\n  - explain ONLY what is missing or happening now\n- NO emojis\n- NO commentary outside JSON\n\n==========================\nüö® KIT (ÿ∑ŸÇŸÖ / kit) DETECTION RULES (HIGHEST PRIORITY)\n==========================\n\nTHIS RULE HAS ABSOLUTE PRIORITY OVER ALL OTHER RULES.\n\nIf ANY INDIVIDUAL ITEM contains:\n- the Arabic word \"ÿ∑ŸÇŸÖ\"\n- OR the English word \"kit\" (case-insensitive)\n\nTHEN FOR THAT ITEM ONLY:\n\n- IGNORE VIN detection\n- IGNORE ambiguity rules\n- IGNORE part parsing\n- IGNORE meaningless words\n\nDO THE FOLLOWING:\n- scenario = \"kit\"\n- vin = \"\"\n- part_name = [ FULL original item text unchanged ]\n- DO NOT execute any tool\n- human_text MUST indicate a kit was detected and next step is kit processing\n\nOther items in the same input MUST continue normal processing.\n\n==========================\nVIN DETECTION HARD RULES\n==========================\n\nA valid VIN is:\n- EXACTLY 17 characters\nOR\n- EXACTLY 7 characters AND contains at least one digit\n\n==========================\nMULTI-ITEM PARSING RULES (CRITICAL)\n==========================\n\nIf the user input contains connectors like:\n- \"and\", \"&\", \"Ÿà\", \",\", \" ÿ´ŸÖ \"\n\nYou MUST:\n\n1) Split the input into SEPARATE logical items\n2) TRIM each item\n3) Process EACH item COMPLETELY INDEPENDENTLY\n4) NEVER let one item affect another\n\n==========================\nAMBIGUITY & CLARIFICATION RULES (PER ITEM ONLY)\n==========================\n\nAmbiguity MUST be evaluated PER ITEM ‚Äî NEVER on the full input.\n\nAn item is AMBIGUOUS ONLY if THAT ITEM alone does not uniquely identify a physical part.\n\nAmbiguous categories include:\n- filter\n- brake\n- suspension\n- belt\n- sensor\n- bearing\n- mount\n- lamp / light\n\nRules:\n- If ONE item is ambiguous:\n  - ONLY that item becomes unrecognized\n- Other valid items MUST still return scenario \"part\"\n\nClarification behavior FOR THAT ITEM ONLY:\n- scenario = \"unrecognized\"\n- vin = \"\"\n- part_name = []\n- human_text asks ONLY for missing detail of that item\n\nExamples:\n- \"oil filter and brake pad\"\n  - oil filter ‚Üí VALID part\n  - brake pad ‚Üí AMBIGUOUS (ask front or rear)\n\n==========================\nPART EXECUTION RULES\n==========================\n\nIf an item is NOT ambiguous:\n- scenario = \"part\"\n- part_name = [ normalized English singular part ]\n- execute resolve_part\n\n==========================\nPART NORMALIZATION RULES\n==========================\n\n- Translate to English\n- lowercase\n- singular\n- ALWAYS output as array\n\n==========================\nOUTPUT FORMAT (PER ITEM)\n==========================\n\n{\n  \"scenario\": \"<vin | part | kit | finalize | unrecognized>\",\n  \"vin\": \"\",\n  \"part_name\": [],\n  \"human_text\": \"\"\n}\n\n==========================\nFINAL OUTPUT RULE\n==========================\n\n- If ONE item ‚Üí output ONE JSON OBJECT\n- If MULTIPLE items ‚Üí output a JSON ARRAY\n- NEVER merge items\n- NEVER drop valid items because another item is ambiguous\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1888,
        1440
      ],
      "id": "90a27323-ac44-4720-831c-dc62aa0f3a19",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "description": "use this tool when the user message is text that has a vin number .",
        "jsCode": "// --- Tool Input ---\nconst inputText = query.vin; // Input parameter is named 'vin' in the schema\nlet extractedVin = null;\nlet finalVin = null;\nlet intent = 'get_vehicle_info'; // Define the intent for this tool\n\n// --- 1. Clean Input Text & Extract Potential VIN (7 or 17) ---\nif (inputText && typeof inputText === 'string') {\n  const cleanedInput = inputText\n    .toUpperCase()\n    .replace(/[\\W_]/g, \"\")\n    .replace(/O/g, \"0\")\n    .replace(/I/g, \"1\")\n    .replace(/Q/g, \"0\");\n\n  // Try 17-character VIN first\n  const match17 = cleanedInput.match(/[A-HJ-NPR-Z0-9]{17}/);\n\n  // If not found, try 7-character VIN\n  const match7 = cleanedInput.match(/[A-HJ-NPR-Z0-9]{7}/);\n\n  if (match17) {\n    extractedVin = match17[0];\n  } else if (match7) {\n    extractedVin = match7[0];\n  }\n}\n\n// --- 2. Normalize Extracted VIN to Last 7 ---\nif (extractedVin) {\n  if (extractedVin.length === 17) {\n    finalVin = extractedVin.slice(-7);\n  } else if (extractedVin.length === 7) {\n    finalVin = extractedVin;\n  } else {\n    finalVin = null;\n  }\n}\n\n// --- 3. Save Intent to Workflow Static Data ---\nlet chatId = null;\n\n// Read chat_id from previous node (unchanged)\nchatId = $('Add Global Variables').item.json.data.chat_id;\n\nif (chatId) {\n  $execution.customData.set('last_intent', intent);\n  $execution.customData.set('processed_vin_7', finalVin);\n  console.log(`Execution data set: intent=${intent}, vin=${finalVin} for chat ${chatId}`);\n} else {\n  console.error(\"Chat ID is missing, cannot save execution state.\");\n  return \"Error: Could not determine chat ID to save state.\";\n}\n\n// --- 4. Tool Output (UNCHANGED BEHAVIOR) ---\nif (finalVin) {\n  return `ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ VIN ${finalVin} ÿ®ŸÜÿ¨ÿßÿ≠.`; // Egyptian Arabic\n} else {\n  return \"ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ VIN ÿµÿßŸÑÿ≠ ŸÅŸä ÿßŸÑŸÜÿµ.\"; // Egyptian Arabic\n}\n",
        "specifyInputSchema": true,
        "jsonSchemaExample": "{\n\t\"vin\": \"some_value\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        2016,
        1664
      ],
      "id": "779db9ed-5759-45ca-820c-281d35614ab0",
      "name": "get_vehicle_info"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "function safeParse(value) {\n  if (value === null || value === undefined) return null;\n\n  // If it's already an object or array, return as-is\n  if (typeof value === 'object') return value;\n\n  // If it's a string, try parsing JSON\n  if (typeof value === 'string') {\n    try {\n      const parsed = JSON.parse(value);\n      return parsed;\n    } catch (e) {\n      // Not JSON, return original string\n      return value;\n    }\n  }\n\n  // Fallback\n  return value;\n}\n\nreturn {\n  chat_id: safeParse($json['Chat ID']),\n  conversation_id: safeParse($json.conversationId),\n  vin: safeParse($json.vin),\n  vehicle_info: safeParse($json.vehicle_info),\n  quotation_id: safeParse($json.quotation_id),\n  basket: safeParse($json.basket),\n  history: safeParse($json.history),\n  tenant_id: safeParse($json.tenant_id),\n  user_id: safeParse($json.user_id)\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        1344
      ],
      "id": "0e52f267-e522-4fb8-acc2-b6d74240dcb1",
      "name": "Parse State"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2414e0f4-123d-4477-84f7-5a38b044586e",
              "leftValue": "={{ $json._id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -928,
        1552
      ],
      "id": "ca5fc9e8-b0c6-40c6-9091-cb3aaefd555a",
      "name": "State Exists?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5007b5aa-630d-4be5-af5c-b6cf26b6986a",
              "name": "chat_id",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "25867f88-cbb7-495f-8a56-b593a360bde0",
              "name": "tenant_id",
              "value": "={{ $('Pull Tenant Info').item.json._id }}",
              "type": "string"
            },
            {
              "id": "30594696-7550-411d-86dc-d5ef96eeec37",
              "name": "user_id",
              "value": "={{ $('Query Chat ID in Existing Users').item.json._id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        192,
        1536
      ],
      "id": "4daab4c9-616a-4678-8ac8-053ed12a835f",
      "name": "Create Initial State"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.ocr.space/parse/image",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "=file",
              "inputDataFieldName": "data"
            },
            {
              "name": "=OCREngine",
              "value": "2"
            },
            {
              "name": "language",
              "value": "eng"
            },
            {
              "name": "OCREngine",
              "value": "2"
            },
            {
              "name": "scale",
              "value": "true"
            },
            {
              "name": "detectOrientation",
              "value": "true"
            },
            {
              "name": "isOverlayRequired",
              "value": "false"
            },
            {
              "name": "filetype",
              "value": "JPG"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1312,
        1344
      ],
      "id": "9d78b9a8-24dc-470d-9ffc-16dd6c335740",
      "name": "ocr.space",
      "credentials": {
        "httpHeaderAuth": {
          "id": "N8gZg3hx61XnnaF0",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Bv5ZZMIP1ImMPLPC0KE1UrIjCSh-1aypIoq99BR9r0s",
          "mode": "list",
          "cachedResultName": "Auto Scraper Hot Items",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Bv5ZZMIP1ImMPLPC0KE1UrIjCSh-1aypIoq99BR9r0s/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Bv5ZZMIP1ImMPLPC0KE1UrIjCSh-1aypIoq99BR9r0s/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Item Desc",
              "lookupValue": "={{ $json.part }}"
            }
          ]
        },
        "options": {
          "returnFirstMatch": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5840,
        1440
      ],
      "id": "6c0fa9fc-c0bc-4ebf-901c-2532dcbed1e7",
      "name": "Check Hot Item (Google Sheets)",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GQOyMlP0F8zR1D3O",
          "name": "Google Sheets account 4"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "0b9cc175-80ae-4c0e-b97d-af8573dc776a",
              "leftValue": "={{ $json['Item Desc'] }}",
              "rightValue": 0,
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6064,
        1440
      ],
      "id": "27c1b9fb-4060-49f2-af2c-6897c591e533",
      "name": "Found in Hot Items?",
      "alwaysOutputData": true,
      "executeOnce": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://scraper-api-207722784991.europe-west3.run.app/realoem/find-part",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "vin",
              "value": "={{ $('choose last qoutation').item.json.vin }}"
            },
            {
              "name": "part",
              "value": "=Spark plug"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9904,
        1216
      ],
      "id": "32656ee3-b0ab-40dc-bdfb-abd442984026",
      "name": "Direct Lookup by Part (HTTP B)",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "=https://scraper-api-207722784991.europe-west3.run.app/realoem/get-car-details/{{ $items(\"format AI output\")[0].json.vin }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3248,
        688
      ],
      "id": "86ebf440-edbc-4fed-a834-1eefbbd09488",
      "name": "VIN Scraper (HTTP)",
      "alwaysOutputData": true,
      "executeOnce": true,
      "retryOnFail": true,
      "maxTries": 2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "You are an automotive part categorization assistant. Given a user's description of a part, determine:\n\n1.  The **Top 3 most likely Main Groups** it belongs to, in order of confidence. Select ONLY from this list: [TECHNICAL LITERATURE, SERVICE AND SCOPE OF REPAIR WORK, RETROFITTING / CONVERSION / ACCESSORIES, PARTS REPAIR SERVICE, ENGINE, ENGINE ELECTRICAL SYSTEM, FUEL PREPARATION SYSTEM, FUEL SUPPLY, RADIATOR, EXHAUST SYSTEM, CLUTCH, ENGINE AND TRANSMISSION SUSPension, MANUAL TRANSMISSION, AUTOMATIC TRANSMISSION, GEAR SHIFT, DRIVE SHAFT, FRONT AXLE, STEERING, REAR AXLE, BRAKES, PEDALS, WHEELS, BODYWORK, VEHICLE TRIM, SEATS, SLIDING ROOF / FOLDING TOP, VEHICLE ELECTRICAL SYSTEM, INSTRUMENTS MEASURING SYSTEMS, LIGHTING, HEATER AND AIR CONDITIONING, AUDIO, NAVIGATION, ELECTRONIC SYSTEMS, DISTANCE SYSTEMS, CRUISE CONTROL, EQUIPMENT PARTS, RESTRAINT SYSTEM AND ACCESSORIES, AUXILIARY MATERIALS, FLUIDS&COLOR SYSTEM, COMMUNICATION SYSTEMS, COMPLETE WHEELS, TIRES AND WHEEL RIMS, VALUE PARTS&PACKAGES SERVICE AND REPAIR].\n2.  The likely **Technical Name** (professional term) for this part.\n3.  A list of 2-3 **Likely Aliases** (common or slang names) for this part.\n\nOutput ONLY a JSON object with these keys:\n* `main_group`: The #1 most likely group (string, from the list or \"UNKNOWN\").\n* `other_groups`: The #2 and #3 likely groups (array of strings, e.g., [\"GROUP2\", \"GROUP3\"]).\n* `technical_name`: The professional name (string, or null if unknown).\n* `likely_aliases`: Common names (array of strings, or an empty array []).\n\nExample Input: \"front brake rotor\"\nExample Output: {\n  \"main_group\": \"BRAKES\",\n  \"other_groups\": [\"WHEELS\", \"FRONT AXLE\"],\n  \"technical_name\": \"Brake Disc\",\n  \"likely_aliases\": [\"rotor\", \"front disc\", \"brake disc\"]\n}\n\nExample Input: \"ac fan\"\nExample Output: {\n  \"main_group\": \"HEATER AND AIR CONDITIONING\",\n  \"other_groups\": [\"RADIATOR\", \"ENGINE ELECTRICAL SYSTEM\"],\n  \"technical_name\": \"Condenser Fan\",\n  \"likely_aliases\": [\"aux fan\", \"radiator fan\", \"cooling fan\"]\n}\n",
              "role": "system"
            },
            {
              "content": "={{ $node[\"seperate parts\"].json[\"part\"] }}"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        6960,
        1360
      ],
      "id": "2a673b6c-3149-46c5-99d8-29e70420f83d",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "oxxlOcTwmUo3iwru",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://scraper-api-207722784991.europe-west3.run.app/realoem/query-group/",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={ \n  \"vin\": \"D978816\", \n  \"group\": \"radiator\" \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7984,
        1408
      ],
      "id": "0811089c-7364-478e-a832-ee94eaeccc51",
      "name": "Scrape Realoem (HTTP A)",
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "You are an expert automotive parts specialist. A scoring algorithm has narrowed down the options to two, but it is not confident enough to choose. Your task is to act as the tie-breaker.\n\nYou will be given a \"Target Keyword\" and two \"Options\".\n1.  Analyze the Target Keyword.\n2.  Analyze Option A and Option B, paying close attention to their descriptions and any supplemental notes.\n3.  Choose the SINGLE best option.\n4.  Output ONLY a JSON object containing *the full object* of the part you selected.\n\nExample: If Option A is the better choice, your entire output should be:\n{\n  \"part_number\": \"17117805630\",\n  \"description\": \"Auxiliary cooling fan\",\n  \"score\": 0.916,\n  \"original_part\": {\n    \"item_no\": \"01\",\n    \"description\": \"Auxiliary cooling fan\",\n    \"supplement\": null,\n    \"quantity\": \"1\",\n    \"from_date\": null,\n    \"to_date\": null,\n    \"part_number\": \"17117805630\",\n    \"price\": null,\n    \"notes\": [\"only in conjunction with\", \"-- Damping element 2 17117575251\"]\n  }\n}\n\nIf neither part is a good match, return an empty JSON object: {}",
              "role": "system"
            },
            {
              "content": "=Target Keyword: radiator right\n\n---\nOption A:\n{{ $json.output.best_match.toJsonString() }}\n\n---\nOption B:\n{{ $json.output.second_match.toJsonString() }}\n---\n\nPlease analyze these two options and return *only* the JSON object of the single best match.\nand must add diagram url dont forget"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        8656,
        1792
      ],
      "id": "4f03b1aa-a0f4-4de8-a08c-2847c7aa0895",
      "name": "evaluate scraper results",
      "executeOnce": false,
      "credentials": {
        "openAiApi": {
          "id": "oxxlOcTwmUo3iwru",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "let chatId = null;\ntry {\n    // Get chat_id (must be consistent with how the Tool saved it)\n ¬† ¬†// Assumes 'Add Global Variables' node ran and set this structure\n ¬† ¬†chatId = $('Add Global Variables').item.json.data.chat_id;\n} catch (e) {\n    console.error(\"Router could not get chat_id from 'Add Global Variables':\", e);\n    // Optional Fallback: Try getting from Trigger if the above fails\n    try {\n        chatId = $getExecution('d4a6c6').item.json.message.chat.id; // Telegram Trigger ID\n    } catch (e2) {\n         console.error(\"Router could not get chat_id from Telegram Trigger either:\", e2);\n    }\n}\n\nlet intent = null;\nif (chatId) {\n    // Check if customData and get method exist\n \n        intent = $execution.customData.get('last_intent'); // Read the saved intent\n        console.log(`Router read execution data: intent=${intent} for chat ${chatId}`);\n        \n        // Optional: Clear the intent after reading if it's only needed once per execution\n        // $execution.customData.set('last_intent', null);\n\n} else {\n    console.error(\"Router: Chat ID missing.\");\n    intent = null; // Ensure intent is null if chatId is missing\n}\n\n// Output the intent (which might be null if reading failed) for the Switch node\nreturn { last_intent: intent };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        1440
      ],
      "id": "2952c74f-404f-4ac0-88ee-81708c076321",
      "name": "Router"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"data\": {\n    \"chat_id\": {{ $('Telegram Trigger').item.json.message.chat.id }}\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        640,
        1440
      ],
      "id": "79ca4275-4061-4e40-bab4-3dccd746c164",
      "name": "Add Global Variables"
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "sale.order",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "partner_id",
              "fieldValue": "={{ (()=>{ \n  try { return $('Create Customer').item.json.id } catch(e) {}\n  try { return $('search for contact').item.json.id } catch(e) {}\n  try { return $('Search x_car').item.json.x_studio_partner_id[0] } catch(e) {}\n  return null;\n})() }}"
            },
            {
              "fieldName": "partner_invoice_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "partner_shipping_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "x_studio_car",
              "fieldValue": "={{ $('Search x_car').item.json.id ?? $json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        6736,
        928
      ],
      "id": "42bc1d65-3b07-444f-9141-c7c1f7c594e3",
      "name": "Create a quotation",
      "executeOnce": true,
      "credentials": {
        "odooApi": {
          "id": "0NgdIkIsJihhxK00",
          "name": "Dec 25 2025"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// --- Get Data from Previous Nodes ---\n\n// 1. Existing State (Incoming data)\nconst existingState = $json.state || {}; \n\n// 2. Chat ID\nlet chatId = null;\ntry {\n    chatId = $('Add Global Variables').item.json.data.chat_id;\n} catch (e) { \n    console.error(\"Could not get chat_id\", e); \n}\n\n// 3. New Quotation ID\nlet quotationId = null;\ntry {\n    quotationId = $('Create a quotation').item.json.id;\n} catch(e) { \n    console.error(\"Could not get quotationId\", e); \n}\n\n// 4. VIN (Updated to use 'format AI output' node)\nlet cleanVin = null;\ntry {\n    // Taking VIN from the specific node requested\n    cleanVin = $('format AI output').item.json.vin;\n} catch(e) { \n    console.error(\"Could not get clean_vin from format AI output\", e); \n}\n\n// 5. Car Details\nlet carDetails = null;\ntry {\n    carDetails = $('VIN Scraper (HTTP)').item.json;\n} catch(e) { \n    console.error(\"Could not get carDetails\", e); \n}\n\n// 6. Customer Name & Phone (WITH FORMATTING)\nlet customerName = null;\nlet customerPhone = null; \ntry {\n    // Get raw name\n    let rawName = $('Search x_car').item.json.x_studio_partner_id?.[1] || $('Wait for Customer Data').item.json['Car Owner Name'];\n    \n    // --- Task 1: Uppercase First Letters (Title Case) ---\n    if (rawName) {\n        customerName = rawName\n            .toLowerCase()\n            .split(' ')\n            .map(word => word.charAt(0).toUpperCase() + word.slice(1))\n            .join(' ');\n    }\n\n    // Get raw phone\n    let rawPhone = $('Search x_car').item.json.x_studio_partner_phone || $('Wait for Customer Data').item.json['Phone Number'];\n\n    // --- Task 2: Format Phone Number (+20 10...) ---\n    if (rawPhone) {\n        let cleanNumber = String(rawPhone).trim().replace(/^(\\+20|0020|0)/, '');\n        customerPhone = `+20 ${cleanNumber}`;\n    }\n\n} catch(e) { \n    console.error(\"Could not get customer info\", e); \n}\n\n// 7. Car ID\nlet carId = null;\ntry {\n    carId = $('Search x_car').item.json.id || $('Create a new car').item.json.id;\n} catch (e) {\n    console.error(\"Could not get carId\", e);\n}\n\n// --- Create Updated State Object ---\nconst newState = { \n    ...existingState,\n    ...(chatId !== null && { chat_id: String(chatId) }),\n    ...(cleanVin !== null && { vin: cleanVin }),\n    ...(quotationId !== null && { quotation_id: quotationId }),\n    ...(customerName !== null && { customer_name: customerName }),\n    ...(customerPhone !== null && { customer_phone: customerPhone }),\n    ...(carDetails !== null && { vehicle_details: carDetails }),\n    ...(carId !== null && { x_car_id: carId }),\n    status: \"open\"\n};\n\n// --- Prepare Output ---\nreturn newState;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7024,
        928
      ],
      "id": "c2eb20ab-a7ea-49ca-b6ae-947206493f05",
      "name": "Prepare Updated State"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0fa0b827-c88b-4842-90a5-d4f374af3e8f",
              "name": "userMessage",
              "value": "={{ $json.ParsedResults[0].ParsedText }}",
              "type": "string"
            },
            {
              "id": "94822963-c99d-49fc-99ff-532d0ae0d17e",
              "name": "sessionId",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1536,
        1344
      ],
      "id": "d6f70b73-5220-4891-8235-3614e8e86271",
      "name": "Set OCR Text"
    },
    {
      "parameters": {
        "description": "Use this when the user asks for a specific automotive part by name. Saves the intent and part name.",
        "jsCode": "// --- Tool Input ---\n// AI Agent passes the part name detected in the user's message\nconst partName = query.part_name; // Use 'input.part_name' due to schema\nconst intent = 'resolve_part'; // Define the intent for this tool\n\n// --- Validate Input ---\nif (!partName || typeof partName !== 'string' || partName.trim() === '') {\n  console.error(\"Resolve Part Tool: Invalid or missing part_name input.\");\n  return \"ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ≠ÿØÿØ ŸÇÿ∑ÿπÿ© ÿßŸÑÿ∫Ÿäÿßÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ®ÿßÿ≥ŸÖ Ÿàÿßÿ∂ÿ≠.\"; // Egyptian Arabic: Please specify the required part with a clear name.\n}\n\n// --- Save Intent and Part Name to Execution State ---\nlet chatId = null;\ntry {\n  // Get chat_id (use the same reliable method as in get_vehicle_info)\n  chatId = $('Add Global Variables').item.json.data.chat_id;\n} catch (e) { console.error(\"Resolve Part Tool: Could not get chat_id\", e); }\n\n\nif (chatId) {\n    // Check if customData and set method exist\n     \n        $execution.customData.set('last_intent', intent);\n        $execution.customData.set('current_part_query', partName); // Save the part name\n        console.log(`Execution data set: intent=${intent}, part_query=${partName} for chat ${chatId}`);\n     \n} else {\n    console.error(\"Resolve Part Error: Chat ID is missing, cannot save execution state.\");\n    return \"Error: Could not determine chat ID to save state.\";\n}\n\n// --- Tool Output ---\n// Return a simple confirmation string back to the AI Agent\n// Let the Router/Switch handle the actual lookup logic based on the saved intent\nreturn `ÿ™ŸÖÿßŸÖÿå ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ '${partName}'...`; // Egyptian Arabic: Okay, searching for '[partName]'...",
        "specifyInputSchema": true,
        "jsonSchemaExample": "{\n\t\"part_name\": \"some_value\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        2144,
        1664
      ],
      "id": "25816dfd-7145-47da-acc7-c57dd90e03c0",
      "name": "resolve_part"
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "x_car",
        "operation": "getAll",
        "returnAll": true,
        "options": {},
        "filterRequest": {
          "filter": [
            {
              "fieldName": "x_studio_car_chasis",
              "operator": "like",
              "value": "={{ $('format AI output').item.json.vin }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        4048,
        784
      ],
      "id": "38f99ba0-5cca-4906-b873-7ac5f73fdda6",
      "name": "Search x_car",
      "alwaysOutputData": true,
      "credentials": {
        "odooApi": {
          "id": "0NgdIkIsJihhxK00",
          "name": "Dec 25 2025"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "c7a09abf-dece-4dcf-94ae-2d0ffaa6ff2e",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4272,
        784
      ],
      "id": "536ac990-402a-49ff-835f-bf263a4a8004",
      "name": "x_car Exists?",
      "executeOnce": false
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "x_car",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "x_name",
              "fieldValue": "=BMW {{ $('VIN Scraper (HTTP)').item.json.series }}"
            },
            {
              "fieldName": "x_studio_car_chasis",
              "fieldValue": "={{ $('format AI output').item.json.vin }}"
            },
            {
              "fieldName": "x_studio_car_year",
              "fieldValue": "={{ $('VIN Scraper (HTTP)').item.json.prod_month }}"
            },
            {
              "fieldName": "x_studio_specs",
              "fieldValue": "=  body :{{ $('VIN Scraper (HTTP)').item.json.body }}, model:{{ $('VIN Scraper (HTTP)').item.json.model }}, market:{{ $('VIN Scraper (HTTP)').item.json.market }}, engine:{{ $('VIN Scraper (HTTP)').item.json.engine }} "
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        4496,
        1056
      ],
      "id": "57dba98b-9190-44d1-b780-30db05c50c92",
      "name": "Create a new car",
      "credentials": {
        "odooApi": {
          "id": "0NgdIkIsJihhxK00",
          "name": "Dec 25 2025"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Add Global Variables').item.json.data.chat_id }}",
        "text": "=üßæ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿπÿ± ÿ±ŸÇŸÖ: {{ $('Create a quotation').item.json.id }}\nVIN: {{ $('format AI output').item.json.vin }}\nÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©:\nüöó ÿßŸÑŸÖŸàÿØŸäŸÑ: {{ $('VIN Scraper (HTTP)').item.json.series }} {{ $('VIN Scraper (HTTP)').item.json.model }}\nüöô ÿßŸÑŸáŸäŸÉŸÑ: {{ $('VIN Scraper (HTTP)').item.json.body }}\nüåç ÿßŸÑÿ≥ŸàŸÇ: {{ $('VIN Scraper (HTTP)').item.json.market }}\nüìÖ ÿ≥ŸÜÿ© ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨: {{ $('VIN Scraper (HTTP)').item.json.prod_month }}\n‚öôÔ∏è ÿßŸÑŸÖÿ≠ÿ±ŸÉ: {{ $('VIN Scraper (HTTP)').item.json.engine }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        7536,
        928
      ],
      "id": "9e945dda-0858-4376-9500-21c4dec076c3",
      "name": "Send a text message",
      "webhookId": "63ee652a-f9e3-45a2-a4a6-5347ad9d5fff",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "addfa104-9555-42ba-8f48-882063c2212b",
              "leftValue": "={{ $('Direct Lookup by Part (HTTP B)').item.json }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        10128,
        1216
      ],
      "id": "5cd19997-9474-4ae2-a988-f77d3cc729b3",
      "name": "Did Scraper output a result?"
    },
    {
      "parameters": {
        "jsCode": "// 1) Get part_number from \"normalize input\"\nconst partNumber = $('normalize input').first().json.part_number;\n\nif (!partNumber) {\n  return { error: \"part_number missing from 'normalize input'\" };\n}\n\n// 2) Get all Odoo products from \"Search for item\" (GetAll node)\nconst odooItems = $items('Search for item', 0, 0).map(item => item.json);\n\n// 3) Final output (only one object)\nreturn {\n  part_number: String(partNumber),\n  products: odooItems\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11232,
        1264
      ],
      "id": "4a06142c-729d-4c6d-b74f-3c3f11836536",
      "name": "Update State"
    },
    {
      "parameters": {
        "jsCode": "// Input $json contains either { chatId, message, basketIsEmpty: true }\n// OR { chatId, stateToSave, addedPartDesc, basketIsEmpty: false/true }\n\nconst chatId = $json.chatId;\nconst basketIsEmpty = $json.basketIsEmpty; // Check the flag from upstream\nconst addedPartDesc = $json.addedPartDesc; // Only exists if part was added\nlet message = \"\";\n\nif (addedPartDesc) { // If we successfully added a part\n    message = `ÿ™ŸÖÿßŸÖÿå ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© '${addedPartDesc}' ŸÑŸÑÿ≥ŸÑÿ©. `;\n} else if ($json.message) { // If scraper failed after hot item found\n    message = $json.message + \" \"; // Use the \"No Result\" message\n} else {\n    message = \"\"; // Fallback if something unexpected happened\n}\n\n// Append the next question\nif (basketIsEmpty) {\n    message += \"ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÇÿ∑ÿπÿ© ÿ£ÿÆÿ±Ÿâÿü\";\n    // Egyptian Arabic: \"Do you want to search for another part?\"\n} else {\n    message += \"ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ÿ£ÿÆÿ±Ÿâ ÿü\";\n    // Egyptian Arabic: \"Add another part or send quote to client for confirmation?\"\n}\n\nreturn {\n    chatId: chatId,\n    text: message.trim(),\n    // Pass flag indicating if basket allows sending\n    canSendToCustomer: !basketIsEmpty\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12800,
        1264
      ],
      "id": "2599008d-8ac5-4663-9c88-35d939ae3117",
      "name": "Prepare Add more mesage"
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "message": "={{ $json.text }}",
        "approvalOptions": {
          "values": {
            "approvalType": "double"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        13024,
        1264
      ],
      "id": "152e70bb-ad52-4a65-89e4-e5cf1bc5c0b6",
      "name": "Ask if want to add more items?",
      "webhookId": "c8f6b32f-63e5-4f6d-850b-e62e770486bf",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "product.template",
        "operation": "getAll",
        "returnAll": true,
        "options": {
          "fieldsList": [
            "active",
            "name",
            "standard_price",
            "x_studio_product_brand",
            "qty_available",
            "categ_id",
            "x_studio_internal_reference",
            "x_studio_oen",
            "id"
          ]
        },
        "filterRequest": {
          "filter": [
            {
              "fieldName": "x_studio_oen",
              "operator": "like",
              "value": "=64529399059"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        10784,
        1312
      ],
      "id": "bd7954bf-312f-4033-8c8f-ea64392da796",
      "name": "Search for item",
      "alwaysOutputData": true,
      "credentials": {
        "odooApi": {
          "id": "o2bcsN7FCWCoeuxb",
          "name": "Odoo account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ================================================================\n// UNIVERSAL PART SCORING CODE NODE\n// Works with: Scraper output + DB output + mixed inputs\n// ================================================================\n\n// ---------------- HELPER: Levenshtein ----------------\nfunction getLevenshtein(a, b) {\n  if (!a.length) return b.length;\n  if (!b.length) return a.length;\n\n  const m = Array.from({ length: a.length + 1 }, () =>\n    Array(b.length + 1).fill(0)\n  );\n\n  for (let i = 0; i <= a.length; i++) m[i][0] = i;\n  for (let j = 0; j <= b.length; j++) m[0][j] = j;\n\n  for (let i = 1; i <= a.length; i++) {\n    for (let j = 1; j <= b.length; j++) {\n      const cost = a[i - 1] === b[j - 1] ? 0 : 1;\n      m[i][j] = Math.min(\n        m[i - 1][j] + 1,\n        m[i][j - 1] + 1,\n        m[i - 1][j - 1] + cost\n      );\n    }\n  }\n  return m[a.length][b.length];\n}\n\n// ---------------- HELPER: Token Set Ratio ----------------\nfunction getTokenSetRatio(a, b) {\n  if (!a || !b) return 0;\n  const A = new Set(a.split(/\\s+/));\n  const B = new Set(b.split(/\\s+/));\n  const inter = [...A].filter(x => B.has(x));\n  const union = new Set([...A, ...B]);\n  return union.size === 0 ? 0 : (inter.length / union.size) * 100;\n}\n\n// ---------------- HELPER: Porter Stemmer ----------------\nconst porterStemmer = (function () {\n  function stem(w) {\n    return w.replace(/(ing|ed|s)$/i, '');\n  }\n  return stem;\n})();\n\nfunction stemSentence(s) {\n  return s\n    .toLowerCase()\n    .split(/\\s+/)\n    .map(w => porterStemmer(w))\n    .join(' ');\n}\n\n// ================================================================\n// 1Ô∏è‚É£ GET TARGET KEYWORD (Alias Node)\n// ================================================================\nlet targetKeyword;\ntry {\n  targetKeyword = $('Search if word is in aliases').first().json['Main Keyword'];\n} catch {\n  return [{ json: { error: 'Main Keyword missing' } }];\n}\n\nconst query = targetKeyword.toLowerCase();\nconst queryStemmed = stemSentence(query);\n\n// ================================================================\n// 2Ô∏è‚É£ NORMALIZE INPUT (DB + Scraper)\n// ================================================================\nconst inputs = $input.all();\n\nconst allSubgroups = [];\n\nfor (const item of inputs) {\n  if (item.json?.subgroups && Array.isArray(item.json.subgroups)) {\n    allSubgroups.push(...item.json.subgroups);\n  }\n}\n\n// Safety check\nif (!allSubgroups.length) {\n  return [{ json: { error: 'No subgroups found in inputs' } }];\n}\n\n// ================================================================\n// 3Ô∏è‚É£ SCORE PARTS\n// ================================================================\nconst uniqueParts = new Map();\n\nfor (const subgroup of allSubgroups) {\n  if (!Array.isArray(subgroup.parts)) continue;\n\n  const diagramUrl = subgroup.diagram_image ?? null;\n\n  for (const part of subgroup.parts) {\n    if (!part.description || !part.part_number) continue;\n\n    const desc = part.description.toLowerCase();\n    const descStemmed = stemSentence(desc);\n\n    const maxLen = Math.max(query.length, desc.length);\n    if (!maxLen) continue;\n\n    const leven = (maxLen - getLevenshtein(query, desc)) / maxLen;\n    const fuzzy = getTokenSetRatio(query, desc) / 100;\n    const lemma = getTokenSetRatio(queryStemmed, descStemmed) / 100;\n\n    const score = (0.6 * fuzzy) + (0.25 * lemma) + (0.15 * leven);\n\n    const existing = uniqueParts.get(part.part_number);\n    if (!existing || score > existing.score) {\n      uniqueParts.set(part.part_number, {\n        part_number: part.part_number,\n        description: part.description,\n        score,\n        original_part: part,\n        diagram_url: diagramUrl\n      });\n    }\n  }\n}\n\n// ================================================================\n// 4Ô∏è‚É£ SORT + OUTPUT\n// ================================================================\nconst ranked = [...uniqueParts.values()].sort((a, b) => b.score - a.score);\n\nreturn [{\n  json: {\n    output: {\n      best_match: ranked[0] ?? { score: 0 },\n      second_match: ranked[1] ?? { score: 0 }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8208,
        1648
      ],
      "id": "91dd7d2c-ee5c-40cc-b473-69893ce37552",
      "name": "Compare Results"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "13PVLyzmhUTYexUx_SFbu8MjmQVGY8JXv0Vnpp-rc6lo",
          "mode": "list",
          "cachedResultName": "Automotive Alias Ma",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13PVLyzmhUTYexUx_SFbu8MjmQVGY8JXv0Vnpp-rc6lo/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13PVLyzmhUTYexUx_SFbu8MjmQVGY8JXv0Vnpp-rc6lo/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Aliases",
              "lookupValue": "={{ $('seperate parts').item.json.part }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6288,
        1504
      ],
      "id": "b17d399f-8c4b-4820-8d06-668c293dd325",
      "name": "Alias Map",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GQOyMlP0F8zR1D3O",
          "name": "Google Sheets account 4"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5bd6db08-a648-4b05-bb28-a49b20c45d4a",
              "leftValue": "={{ $json['Main Group'] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6736,
        1504
      ],
      "id": "5399007f-c8d9-4f28-9a6e-e081f1cb7d6d",
      "name": "if found in alias map?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4353c0d8-07d3-4b29-ac39-eabf23ed41af",
              "leftValue": "={{ $json.output.best_match.score }}",
              "rightValue": 0.88,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            },
            {
              "id": "5f0245b0-d161-4e7b-881b-672d4db314b4",
              "leftValue": "={{ $json.output.best_match.score - $json.output.second_match.score }}",
              "rightValue": 0.08,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8432,
        1648
      ],
      "id": "dca2c539-b8b1-4dea-8dce-ca4021286848",
      "name": "early exit?"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        9008,
        1648
      ],
      "id": "9b58147b-d3ad-4ca6-b9b6-dc4902728655",
      "name": "Merge"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "78215676-30b6-4621-9854-c3062d4d9277",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        10560,
        1632
      ],
      "id": "ea445779-2835-481b-9deb-e9a6d0efbffe",
      "name": "update alias map?"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "13PVLyzmhUTYexUx_SFbu8MjmQVGY8JXv0Vnpp-rc6lo",
          "mode": "list",
          "cachedResultName": "Automotive Alias Ma",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13PVLyzmhUTYexUx_SFbu8MjmQVGY8JXv0Vnpp-rc6lo/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13PVLyzmhUTYexUx_SFbu8MjmQVGY8JXv0Vnpp-rc6lo/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "Main Keyword",
              "displayName": "Main Keyword",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Main Group",
              "displayName": "Main Group",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Other Main Groups",
              "displayName": "Other Main Groups",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Aliases",
              "displayName": "Aliases",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1376,
        2048
      ],
      "id": "eaa65461-c032-478d-b4e0-c6e25c8ba512",
      "name": "update alias map",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GQOyMlP0F8zR1D3O",
          "name": "Google Sheets account 4"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the user's part query from the AI Agent\nlet userQuery = \"\";\ntry {\n  // Assuming output is just the part name, e.g., \"aux fan\"\n  //userQuery = $('AI Agent').item.json.output.toLowerCase().trim();\n  userQuery = \"aux fan\";\n  if (!userQuery) {\n    console.warn(\"User query from AI Agent is empty.\");\n    return []; // No query, so can't find a match\n  }\n} catch (e) {\n  console.error(\"Could not get user query from 'AI Agent' node:\", e);\n  return []; // Stop flow if we can't get the query\n}\n\n// Get all rows from the 'Alias Map'\nconst aliasRows = $('Alias Map').all(); // Using node name 'Alias Map'\nif (!aliasRows.length) {\n  console.warn(\"Alias Map sheet is empty or node failed.\");\n  return []; // No map, so no match\n}\n\nconsole.log(`Searching for query: '${userQuery}'`);\n\n// Loop through each row in the spreadsheet\nfor (const item of aliasRows) {\n  const row = item.json;\n\n  // 1. Get Main Keyword (Column A)\n  const mainKeyword = (row['Main Keyword'] || '').trim(); // Keep original case for output\n  \n  // 2. Get Aliases (Column D)\n  const aliasString = row.Aliases || '';\n  const aliasList = aliasString.split(',')\n                             .map(s => s.toLowerCase().trim());\n\n  // --- Check if query matches either Main Keyword (case-insensitive) or any Alias ---\n  if (mainKeyword.toLowerCase() === userQuery || aliasList.includes(userQuery)) {\n    // --- MATCH FOUND ---\n    console.log(`Found match for '${userQuery}'. Main Keyword: ${mainKeyword}`);\n    \n    // Return the groups AND the Main Keyword to score against\n    return [{\n      json: {\n        'Main Keyword': mainKeyword, // <-- ADDED THIS LINE\n        'Main Group': row['Main Group'],\n        'Other Main Groups': row['Other Main Groups'] || null\n      }\n    }];\n  }\n}\n\n// --- NO MATCH FOUND ---\nconsole.log(`No alias match found for '${userQuery}'.`);\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6512,
        1504
      ],
      "id": "b835115f-679d-4f99-8035-e4acba255952",
      "name": "Search if word is in aliases",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst mainGroup = input['Main Group'];\nconst otherGroupsString = input['Other Main Groups'];\n\nlet allGroups = [];\n\n// Add the main group if it exists\nif (mainGroup) {\n  allGroups.push(mainGroup.trim());\n}\n\n// Add other groups if they exist\nif (otherGroupsString) {\n  const otherGroups = otherGroupsString.split(',')\n                                     .map(s => s.trim())\n                                     .filter(s => s.length > 0); // Filter out empty strings\n  allGroups.push(...otherGroups);\n}\n\n// De-duplicate the list\nconst uniqueGroups = [...new Set(allGroups)];\n\nconsole.log(`Preparing to scrape ${uniqueGroups.length} groups:`, uniqueGroups);\n\n// Create one output item for each unique group\nconst outputItems = uniqueGroups.map(groupName => {\n  return {\n    json: {\n      // This 'group_to_scrape' will be used by the HTTP node\n      group_to_scrape: groupName \n    }\n  };\n});\n\nif (outputItems.length === 0) {\n    console.warn(\"No groups found to scrape after processing alias map results.\");\n}\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7312,
        1504
      ],
      "id": "628191f6-6a1d-48c4-bf4b-6423070cd902",
      "name": "prepare scraping",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "message": "=ŸÑŸÇŸäÿ™ ÿßŸÑŸÇÿ∑ÿπÿ© ÿØŸä:\n\n*ÿßŸÑŸÇÿ∑ÿπÿ©:* {{ $('if gpt decided it is one of them?').item.json.message.content.original_part.description }}\n*ÿ±ŸÇŸÖ ÿßŸÑŸÇÿ∑ÿπÿ© (Part Number):* {{ $('if gpt decided it is one of them?').item.json.message.content.original_part.part_number }}\n*ÿ±ŸÇŸÖ ÿßŸÑÿµŸÜŸÅ (Item No):* {{ $('if gpt decided it is one of them?').item.json.message.content.original_part.item_no }}\n*ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:* {{ $('if gpt decided it is one of them?').item.json.message.content.original_part.notes }}\n\n\n\nŸáŸÑ ÿØŸä ÿßŸÑŸÇÿ∑ÿπÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©ÿü",
        "approvalOptions": {
          "values": {
            "approvalType": "double"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        10112,
        1632
      ],
      "id": "5463f24c-d341-4017-b344-8209375ebaa9",
      "name": "confirm from user",
      "webhookId": "5ea18e97-f0a5-4dbb-9015-692016b81784",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $(\"Telegram Trigger\").first().json.message.chat.id }}",
        "text": "=ÿ™ŸÖÿßŸÖÿå ŸÖÿß ŸáŸä ŸÇÿ∑ÿπÿ© ÿßŸÑÿ∫Ÿäÿßÿ± ÿßŸÑÿ™ÿßŸÑŸäÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ±ŸäÿØ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜŸáÿßÿü",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        13472,
        1168
      ],
      "id": "fc51334c-cfb5-4325-bae5-bd864b944c41",
      "name": "Please Enter the new items name",
      "webhookId": "40325931-4608-4e5c-9205-b27d7a986b47",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2a426c74-1405-43d6-9b32-1991e0b94c53",
              "leftValue": "={{ $json.data.approved }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        10336,
        1632
      ],
      "id": "d997e2d9-8fc7-4ee4-b2e1-e76722af40fd",
      "name": "If approved?1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.from.id }}",
        "text": "ÿ™ŸÖÿßŸÖÿå ÿ¢ÿ≥ŸÅ ÿ¨ÿØÿßŸã.  ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ≠ÿßŸàŸÑ ÿ™ŸàÿµŸÅ ÿßŸÑŸÇÿ∑ÿπÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ™ÿßŸÜŸä ÿ®ŸÉŸÑŸÖÿßÿ™ ÿ£Ÿàÿ∂ÿ≠ÿå ÿ£Ÿà ÿ®ÿßÿ≥ŸÖ ŸÖÿÆÿ™ŸÑŸÅÿå ŸàŸáÿ≠ÿßŸàŸÑ ÿ£ÿ®ÿ≠ÿ´ ŸÖÿ±ÿ© ÿ™ÿßŸÜŸäÿ©.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        10560,
        1824
      ],
      "id": "15ae833f-df4f-4aa8-b7a1-dbd4cecf3924",
      "name": "Send a text message1",
      "webhookId": "9da41a2a-1e06-4a94-b63f-e1f03c3a853b",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2a426c74-1405-43d6-9b32-1991e0b94c53",
              "leftValue": "={{ $json.data.approved }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        13248,
        1264
      ],
      "id": "9ddc80a3-a94b-4bc5-b005-504075b616a8",
      "name": "Will Add More Items?"
    },
    {
      "parameters": {
        "jsCode": "// This node prepares the data for the 'Create Quote on DB' (Firestore) node.\n// It gathers data from the workflow's state and the previous node's output.\n\nlet state = {};\nlet WAMsgID = null;\n\ntry {\n  // 1. Get the persistent state object\n  // This state was loaded by 'State Manager [LOAD]' and parsed by 'Parse State'\n  state = JSON.parse($('Add item to basket').first().json.stateToSave);\n  if (!state) {\n    throw new Error(\"State object from 'Parse State' is undefined.\");\n  }\n\n  // 2. Get the output from the previous node ('Send template' WhatsApp)\n  // This contains the response from the WhatsApp API.\n  const waResponse = $input.first().json;\n\n  // 3. Extract the WA Message ID from the response\n  // This assumes the WA API returns a 'messages' array with an 'id' inside.\n  if (waResponse.messages && waResponse.messages.length > 0 && waResponse.messages[0].id) {\n    WAMsgID = $input.first().json.contacts[0].wa_id\n  } else {\n    console.warn(\"Could not find WAMsgID in the WhatsApp response.\", waResponse);\n  }\n\n} catch (error) {\n  console.error(\"Error preparing data for DB:\", error.message);\n  // Return an error to stop the workflow if state is missing\n  return [{ json: { error: \"Failed to read workflow state or input.\" } }];\n}\n\n// 4. Extract all required data points from the state\n// We use '|| null' to ensure the fields exist as 'null' if not found in the state.\nconst userID = state.user_id || null;\nconst basket = state.basket || []; // Default to an empty array\nconst tenantID = state.tenant_id || null;\nconst merchantQuotationID = state.quotation_id || null;\n\n// 5. Construct the final JSON object\nconst firestoreData = {\n  userID: userID,\n  basket: basket,\n  tenantID: tenantID,\n  merchantQuotationID: merchantQuotationID,\n  WAMsgID: WAMsgID\n};\n\n// Return a single item containing the final, structured JSON object\n// This object will be used by the 'Create Quote on DB' node.\nreturn [{\n  json: firestoreData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15712,
        1264
      ],
      "id": "9148469c-e5e9-4aec-9cd6-35eafe3d2069",
      "name": "Prepare Quote Data For DB"
    },
    {
      "parameters": {
        "content": "Please make this node output:\n1- User ID (userID)\n2- Basket (basket)\n3- Tenant ID (tenantID)\n4- Merchant's Quotation ID (merchantQuotationID)\n5- WA Message ID (WAMsgID)",
        "height": 144,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        7712,
        -48
      ],
      "typeVersion": 1,
      "id": "97a5d91c-242c-4c01-8f07-520447210225",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "Car Registered, please add car owner info",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Add Car Owner Info",
                    "additionalFields": {
                      "url": "={{$execution.resumeFormUrl}}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4720,
        1008
      ],
      "id": "a0279992-6ac0-478c-86af-7d15e002dc48",
      "name": "Open Customer Form",
      "webhookId": "04cd5ac6-4f53-4abd-ba02-c8e28ed37253",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "resume": "form",
        "formTitle": "New Car Registration",
        "formDescription": "Please fill in the car owner information",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Car Owner Name",
              "placeholder": "e.g. Mostafa Hassan",
              "requiredField": true
            },
            {
              "fieldLabel": "Phone Number",
              "fieldType": "number",
              "placeholder": "01234567890",
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4944,
        1008
      ],
      "id": "438acdbd-3d9d-4b32-ab03-cb2b0ee86ec1",
      "name": "Wait for Customer Data",
      "webhookId": "06212d84-ed0a-419c-9a1b-53e37c57e240"
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "res.partner",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "name",
              "fieldValue": "={{ $('format phone number').item.json.formattedName }}"
            },
            {
              "fieldName": "mobile",
              "fieldValue": "={{$('format phone number').item.json.formattedPhone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        6288,
        928
      ],
      "id": "57d1a6dc-5730-440e-8ae2-53c4b75f7654",
      "name": "Create Customer",
      "credentials": {
        "odooApi": {
          "id": "0NgdIkIsJihhxK00",
          "name": "Dec 25 2025"
        }
      }
    },
    {
      "parameters": {
        "content": "Needs attention"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5712,
        -480
      ],
      "typeVersion": 1,
      "id": "58af5439-1158-4395-827f-223150858bb6",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "text": "Customer Notified!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        15936,
        1264
      ],
      "id": "9f6766f9-a94c-4af6-8c26-a1b148396eb7",
      "name": "Notify Service Advisor about Message Sent",
      "webhookId": "878496c3-dcf8-457b-86ad-ea732992257a",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "content": "Please also attach the diagram image provided by scraper in subgroup (and mention Item_no)\n\ngpto has no access to internet , do you want me to download both images and send them as well?\n",
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5616,
        384
      ],
      "typeVersion": 1,
      "id": "bc9897ad-734a-4eb5-8634-3db975f2bca4",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "operation": "query",
        "projectId": "automotiveagent-83ade",
        "query": "={   \"structuredQuery\": {     \"from\": [{ \"collectionId\": \"users\" }],     \"where\": {       \"fieldFilter\": {         \"field\": { \"fieldPath\": \"chatID\" },         \"op\": \"EQUAL\",         \"value\": { \"stringValue\": \"{{ $('Telegram Trigger').item.json.message.chat.id.toString() }}\" }       }     }   } }"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -704,
        1648
      ],
      "id": "2f841751-bac7-4f74-a9fc-6ac6ab4d1134",
      "name": "Query Chat ID in Existing Users",
      "alwaysOutputData": true,
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "159cdfb6-5a3f-4a19-80ec-21759abd64b3",
              "leftValue": "={{ $json.name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -480,
        1648
      ],
      "id": "8fc2f041-422e-4aa4-ad16-1877113a6c64",
      "name": "Found existing user?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "Your Device is not registered Please Contaact your administrator",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        192,
        1744
      ],
      "id": "7db00d1a-d30c-44ff-895c-2ea9c202abbb",
      "name": "Block User",
      "webhookId": "7fa0ee86-d40c-42bd-aa76-c6edf0fe7cf0",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "projectId": "automotiveagent-83ade",
        "collection": "tenants",
        "documentId": "={{ $('Query Chat ID in Existing Users').item.json.tenantID }}"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -256,
        1584
      ],
      "id": "9d161759-8147-4aab-8ab9-d4b352ea94a1",
      "name": "Pull Tenant Info",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e288a873-b09f-464a-a1f1-336222737bba",
              "leftValue": "={{ $json.status }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -32,
        1584
      ],
      "id": "a6c6be24-6758-4835-9c91-eccb46439a07",
      "name": "Is Tenant Active?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "62353f11-0149-4aae-953b-52bec3c1831c",
              "leftValue": "={{ $json.message.content }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        9232,
        1648
      ],
      "id": "ed15c6bc-25c1-4a12-b44a-39bd99f0395b",
      "name": "if gpt decided it is one of them?"
    },
    {
      "parameters": {
        "content": "Please test air and heat conditioning and confirm if it is working or not"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        4160,
        432
      ],
      "id": "545ddf17-481b-4909-bc81-2b0d7a6e09e7",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "text": "Sorry item out of stock or unavailable",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        11232,
        1456
      ],
      "id": "9d871677-05f9-4056-9e42-aec390646820",
      "name": "Send a text message2",
      "webhookId": "953ec897-4599-490f-8eb9-db5f3ccf4a51",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b046c36-e040-46d9-b66a-690c7f63a63b",
              "leftValue": "={{ $json.isEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11008,
        1312
      ],
      "id": "49b3acdf-07ec-495e-939a-d0ca37f3590e",
      "name": "if in stock?"
    },
    {
      "parameters": {
        "jsCode": "// This node normalizes input from two different paths.\n// It searches for a part number in various possible locations\n// and outputs *only* the part number if found.\n\n// Get the first (and only) input item\nconst item = $input.first();\nconst json = item.json;\nlet part_number = null;\n\ntry {\n  // --- Path 2: Direct \"Hot Item\" lookup ---\n  // From \"Did Scraper output a result?\"\n  // Assumes the input is { \"part_number\": \"12345\", ... }\n  if (json.part_number) {\n    part_number = json.part_number;\n    console.log(\"Normalize Input: Found part number from Path 2 (Hot Item)\");\n  }\n\n  // --- Path 1: \"User Approval\" path ---\n  // This data comes from \"If approved?1\", which wraps the output\n  // of \"confirm from user\"\n  else if (json.message && json.message.content) {\n    const content = json.message.content;\n\n    // Check Path 1 (A): From \"confirm from user\" -> \"Merge\" -> \"early exit\"\n    // Assumes { data: {...}, message: { content: { output: { best_match: { part_number: \"...\" } } } } }\n    if (content.output && content.output.best_match && content.output.best_match.part_number) {\n      part_number = content.output.best_match.part_number;\n      console.log(\"Normalize Input: Found part number from Path 1 (Best Match)\");\n    \n    // Check Path 1 (B): Structure implied by \"confirm from user\" template\n    // Assumes { data: {...}, message: { content: { original_part: { part_number: \"...\" } } } }\n    } else if (content.original_part && content.original_part.part_number) {\n      part_number = content.original_part.part_number;\n      console.log(\"Normalize Input: Found part number from Path 1 (Original Part)\");\n\n    // Check Path 1 (C): From \"confirm from user\" -> \"Merge\" -> \"evaluate scraper\"\n    // Assumes { data: {...}, message: { content: { message: { content: { part_number: \"...\" } } } } }\n    } else if (content.message && content.message.content && content.message.content.part_number) {\n      part_number = content.message.content.part_number;\n      console.log(\"Normalize Input: Found part number from Path 1 (Evaluated Scraper)\");\n    }\n  }\n  else{\n    part_number = $('evaluate scraper results').first().json.message.content.original_part.part_number;\n  }\n\n} catch (error) {\n  console.error(\"Normalize Input: Error while processing item:\", error, json);\n  return []; // Output nothing on error\n}\n\n// --- Output ---\n// Only output an item if a part number was successfully extracted.\nif (part_number) {\n  console.log(\"Normalize Input: Extracted part number:\", part_number);\n  return [{\n    json: {\n      // This is the clean payload for the \"Search for item\" node\n      part_number: String(part_number).trim()\n    }\n  }];\n} else {\n  // If no part number was found, output nothing.\n  console.warn(\"Normalize Input: Could not extract part number from input:\", json);\n  return [];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10560,
        1312
      ],
      "id": "28332bbf-0e82-4056-8255-454c1a9465a0",
      "name": "normalize input"
    },
    {
      "parameters": {
        "jsCode": "// =============================\n// 1Ô∏è‚É£ QUOTATION DATA\n// =============================\nconst quotation = $('choose last qoutation').first()?.json ?? {};\nconst name = quotation.customer_name ?? '';\nconst vin = quotation.vin ?? '';\n\nconst vehicleDetails = quotation.vehicle_details ?? {};\nconst car_model = [\n  vehicleDetails.series,\n  vehicleDetails.body,\n  vehicleDetails.model\n].filter(Boolean).join(' ');\n\n// =============================\n// 2Ô∏è‚É£ SERVICE CENTER NAME\n// =============================\nconst prevNodeData = $input.first()?.json ?? {};\nconst esm_markaz_el_5edma = prevNodeData.name ?? '';\n\n// =============================\n// 3Ô∏è‚É£ DATA FROM \"formats user output\"\n// =============================\n// Reaching back to get selection details and labor cost\nconst userOutput = $('formats user output').first()?.json ?? {};\nconst selectionData = userOutput.selections?.[0] ?? {};\nconst labor_cost = Number(userOutput.labor_cost ?? 0);\n\n// =============================\n// 4Ô∏è‚É£ BASKET ITEMS (WITH DEDUPLICATION)\n// =============================\nconst basketItems = $('get basket items').all() ?? [];\nconst seenPartNumbers = new Set(); // To track duplicates\n\nlet partsTotal = 0;\nconst basket = [];\n\nfor (const item of basketItems) {\n  const partNumber = item.json?.part_number ?? '';\n  \n  // CHECK FOR DUPLICATES: skip if part number was already processed\n  if (seenPartNumbers.has(partNumber) || !partNumber) continue;\n  seenPartNumbers.add(partNumber);\n\n  const product = item.json?.products?.[0] ?? null;\n\n  // Pull data from the selection node as priority\n  const price = Number(selectionData.price ?? product?.standard_price ?? 0);\n  partsTotal += price;\n\n  basket.push({\n    part_number: partNumber,\n    name: selectionData.product_name ?? product?.name ?? '',\n    brand: selectionData.brand_name ?? product?.brand?.name ?? '', // Using brand_name from node\n    category_name: selectionData.category_name ?? '', // New object requirement\n    price: price\n  });\n}\n\n// =============================\n// 5Ô∏è‚É£ FINAL TOTALS\n// =============================\nconst total = partsTotal + labor_cost;\n\n// =============================\n// 6Ô∏è‚É£ BASKET TEXT (FOR CHAT)\n// =============================\nconst basket_text = basket\n  .map((item, index) => {\n    return `${index + 1}) ${item.name || '‚Äî'} | ${item.brand || '‚Äî'} | ${item.category_name || '‚Äî'} | ${item.price} EGP`;\n  })\n  .join('\\n');\n\n// =============================\n// 7Ô∏è‚É£ FINAL OUTPUT\n// =============================\nreturn [\n  {\n    json: {\n      name,\n      car_model,\n      vin,\n      basket,           // De-duplicated array\n      basket_text,\n      labor_cost,       // Pulled outside the basket\n      total,            // Calculated total\n      esm_markaz_el_5edma\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15264,
        1360
      ],
      "id": "4ae7fd72-7ca6-4ab6-825f-92cd65f4a051",
      "name": "Prepare whatsapp paramaters"
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "catalogs/realoem",
        "columns": "id"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -1152,
        3168
      ],
      "id": "d6c80a1d-ae80-406e-800e-ed10fa53a59f",
      "name": "Save Scraped Subgroup",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        3168
      ],
      "id": "04ac748a-02f1-4a97-98a1-f4be28d40a66",
      "name": "Prepare Subgroup for DB"
    },
    {
      "parameters": {
        "chatId": "={{ $('Add Global Variables').item.json.data.chat_id }}",
        "text": "=üßæ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿπÿ± ÿ±ŸÇŸÖ: {{ $('Create a quotation').item.json.id }}\nVIN: {{$('AI Agent').item.json.output.split(': ')[1].trim().replace(/\\.$/, '')}}\n\nÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©:\nüöó ÿßŸÑŸÖŸàÿØŸäŸÑ: {{ $('VIN Scraper (HTTP)').item.json.series }} {{ $('VIN Scraper (HTTP)').item.json.model }}\nüöô ÿßŸÑŸáŸäŸÉŸÑ: {{ $('VIN Scraper (HTTP)').item.json.body }}\nüåç ÿßŸÑÿ≥ŸàŸÇ: {{ $('VIN Scraper (HTTP)').item.json.market }}\nüìÖ ÿ≥ŸÜÿ© ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨: {{ $('VIN Scraper (HTTP)').item.json.prod_month }}\n‚öôÔ∏è ÿßŸÑŸÖÿ≠ÿ±ŸÉ: {{ $('VIN Scraper (HTTP)').item.json.engine }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1376,
        -528
      ],
      "id": "8f677fdb-1b9d-4d0f-9721-8b78563a5260",
      "name": "Send a text message3",
      "webhookId": "63ee652a-f9e3-45a2-a4a6-5347ad9d5fff",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=8558973985_manual_state",
        "value": "{\\n \"conversationId\": \"8558973985\",\\n \"vin\": null,\\n \"vehicle_info\": {},\\n \"quotation_id\": null,\\n \"basket\": [],\\n \"history\": [],\\n \"tenant_id\":EtsvQH8spjc6Y9YomGA3 ,\\n \"user_id\":qdwkj9NmHxomNQnecYZB\\n}|"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1376,
        3824
      ],
      "id": "b90a75d8-b324-488a-9f34-da9d3e2c63b2",
      "name": "save initial state1",
      "credentials": {
        "redis": {
          "id": "qgqbn3jb2v3sH1kK",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.from.id }}",
        "text": "={{ $json.human_text }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2576,
        1440
      ],
      "id": "093bc6ac-1ef6-48d7-a6f2-6e306a8ee9ff",
      "name": "Send a text message4",
      "webhookId": "78a69681-c4c3-429c-928e-4fdc6a57c10e",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "x_car",
        "operation": "update",
        "customResourceId": "={{ $('Search x_car').item.json.id || $('Create a new car').item.json.id }}",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "x_studio_partner_id",
              "fieldValue": "={{ $json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        6512,
        1008
      ],
      "id": "6158442f-c67c-40fa-bc6a-f7075c5a1302",
      "name": "update partner id in car",
      "credentials": {
        "odooApi": {
          "id": "0NgdIkIsJihhxK00",
          "name": "Dec 25 2025"
        }
      }
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "sale.order",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "partner_id",
              "fieldValue": "={{ $json.x_studio_partner_id?.[0] ?? $json.id }}"
            },
            {
              "fieldName": "partner_invoice_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "partner_shipping_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "x_studio_car",
              "fieldValue": "={{ $json.id || $('Create a new car').item.json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        -1376,
        2944
      ],
      "id": "7e5c4ced-cba8-4085-988a-78d831235ad2",
      "name": "Create a quotation1",
      "executeOnce": true,
      "credentials": {
        "odooApi": {
          "id": "pLBFJjYIDpXreJIT",
          "name": "Odoo account 3"
        }
      }
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "sale.order",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "partner_id",
              "fieldValue": "={{ $json.x_studio_partner_id?.[0] ?? $json.id }}"
            },
            {
              "fieldName": "partner_invoice_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "partner_shipping_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "x_studio_car",
              "fieldValue": "={{ $json.id || $('Create a new car').item.json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        -1376,
        144
      ],
      "id": "440cbd86-b38e-42ad-a40d-1589f20635fd",
      "name": "Create a quotation2",
      "executeOnce": true,
      "credentials": {
        "odooApi": {
          "id": "pLBFJjYIDpXreJIT",
          "name": "Odoo account 3"
        }
      }
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "sale.order",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "partner_id",
              "fieldValue": "=75991"
            },
            {
              "fieldName": "partner_invoice_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "partner_shipping_id",
              "fieldValue": "=3"
            },
            {
              "fieldName": "x_studio_car",
              "fieldValue": "=15099"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        -1376,
        -80
      ],
      "id": "510788f0-a877-4537-948e-bc3d8fc73970",
      "name": "Create a quotation3",
      "executeOnce": true,
      "credentials": {
        "odooApi": {
          "id": "pLBFJjYIDpXreJIT",
          "name": "Odoo account 3"
        }
      }
    },
    {
      "parameters": {
        "projectId": "automotiveagent-83ade",
        "collection": "sessions",
        "documentId": "={{ $json.message.chat.id }}"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -1152,
        1552
      ],
      "id": "487ea7fb-9d1f-4dad-b3a5-f7dc99d6cd3f",
      "name": "Query ChatID",
      "alwaysOutputData": true,
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "sessions",
        "documentId": "={{ $json.chat_id }}",
        "columns": "tenant_id, user_id"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        416,
        1536
      ],
      "id": "55b5d2c1-a318-43a3-9a18-387d0f2bbb7b",
      "name": "Create Chat Record",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "quotes",
        "columns": "quotation_id, customer_name, customer_phone, vin, vehicle_details, x_car_id, chat_id,status"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        7312,
        928
      ],
      "id": "2f03b52f-d573-449d-9c78-a251b7977238",
      "name": "Create Quotation",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1888,
        1664
      ],
      "id": "2dcb0c01-0ab5-4f8d-b167-a66062e58fc2",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "operation": "upsert",
        "projectId": "automotiveagent-83ade",
        "collection": "quotes"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -1376,
        2720
      ],
      "id": "4232d4db-2c1e-464f-8afe-723733374ac6",
      "name": "Add Item to basket",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8e25a354-32a3-48cd-8b7b-1486e0325ce8",
              "leftValue": "={{ $json.x_studio_partner_id[0] }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "d60035ed-9fda-4f8d-8c69-8e458ce0349e",
              "leftValue": "={{ $json.x_studio_partner_id[0] }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4496,
        736
      ],
      "id": "a06f712e-2364-4608-9d0f-7874fcecea2d",
      "name": "customer exists?"
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "x_car",
        "fieldsToCreateOrUpdate": {
          "fields": [
            {
              "fieldName": "x_name",
              "fieldValue": "=BMW {{ $('VIN Scraper (HTTP)').item.json.series }}"
            },
            {
              "fieldName": "x_studio_car_chasis",
              "fieldValue": "={{ $('AI Agent').item.json.output.split(': ')[1].trim().replace(/\\.$/, '') }}"
            },
            {
              "fieldName": "x_studio_car_year",
              "fieldValue": "={{ $('VIN Scraper (HTTP)').item.json.prod_month }}"
            },
            {
              "fieldName": "x_studio_specs",
              "fieldValue": "=  body :{{ $('VIN Scraper (HTTP)').item.json.body }}, model:{{ $('VIN Scraper (HTTP)').item.json.model }}, market:{{ $('VIN Scraper (HTTP)').item.json.market }}, engine:{{ $('VIN Scraper (HTTP)').item.json.engine }} "
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        -1376,
        2496
      ],
      "id": "644bbceb-b1a0-4110-aa2a-c5ece8bfd7a0",
      "name": "Create a new car1",
      "credentials": {
        "odooApi": {
          "id": "pLBFJjYIDpXreJIT",
          "name": "Odoo account 3"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"scenario\":\"string\",\n  \"vin\":\"string\",\n  \"part_name\":[],\n  \"human_text\":\"string\"\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1376,
        3616
      ],
      "id": "0279e695-f12e-45b7-9299-240e8b9b06a9",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node (Run once for all items)\n// Goal: read input.output (string), extract the FIRST valid JSON payload, parse it,\n// and return one item per parsed object (array -> many items, object -> 1 item).\n\nconst input = $input.first().json;\n\nif (typeof input.output !== \"string\") {\n  throw new Error(\"Expected input.output to be a JSON string\");\n}\n\nfunction stripCodeFences(s) {\n  // Remove ```json ... ``` or ``` ... ```\n  return s.replace(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/gi, \"$1\").trim();\n}\n\n// Extract first JSON object/array from a text blob using bracket matching\nfunction extractFirstJson(text) {\n  const s = stripCodeFences(String(text || \"\")).trim();\n\n  const startObj = s.indexOf(\"{\");\n  const startArr = s.indexOf(\"[\");\n  if (startObj === -1 && startArr === -1) return \"\";\n\n  const start = (startArr !== -1 && (startObj === -1 || startArr < startObj)) ? startArr : startObj;\n  const openChar = s[start];\n  const closeChar = openChar === \"[\" ? \"]\" : \"}\";\n\n  let depth = 0;\n  let inString = false;\n  let escape = false;\n\n  for (let i = start; i < s.length; i++) {\n    const ch = s[i];\n\n    if (inString) {\n      if (escape) {\n        escape = false;\n      } else if (ch === \"\\\\\") {\n        escape = true;\n      } else if (ch === '\"') {\n        inString = false;\n      }\n      continue;\n    }\n\n    if (ch === '\"') {\n      inString = true;\n      continue;\n    }\n\n    if (ch === openChar) depth++;\n    if (ch === closeChar) depth--;\n\n    // Support nested mixed {} and [] too\n    if (ch === \"{\") depth += (openChar !== \"{\") ? 1 : 0;\n    if (ch === \"}\") depth -= (openChar !== \"{\") ? 1 : 0;\n    if (ch === \"[\") depth += (openChar !== \"[\") ? 1 : 0;\n    if (ch === \"]\") depth -= (openChar !== \"[\") ? 1 : 0;\n\n    if (depth === 0) {\n      return s.slice(start, i + 1).trim();\n    }\n  }\n\n  // If we didn‚Äôt close properly, fallback to full trimmed\n  return s;\n}\n\nlet raw = input.output;\nlet jsonText = extractFirstJson(raw);\n\nif (!jsonText) {\n  throw new Error(\"No JSON found in input.output\");\n}\n\nlet parsed;\ntry {\n  parsed = JSON.parse(jsonText);\n} catch (e) {\n  throw new Error(\"input.output is not valid JSON: \" + e.message + \"\\nExtracted:\\n\" + jsonText);\n}\n\n// If AI returned TWO objects back-to-back, you‚Äôll often see something like: {}{}\nif (!Array.isArray(parsed) && typeof parsed === \"string\") {\n  // very rare, but just in case\n  parsed = JSON.parse(parsed);\n}\n\nconst arr = Array.isArray(parsed) ? parsed : [parsed];\n\n// Return one n8n item per object\nreturn arr.map(obj => ({\n  json: {\n    scenario: String(obj.scenario ?? \"\"),\n    vin: String(obj.vin ?? \"\"),\n    part_name: Array.isArray(obj.part_name) ? obj.part_name.map(String) : [],\n    human_text: String(obj.human_text ?? \"\")\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        1440
      ],
      "id": "b769411f-a983-4fc0-94f8-0e177dd8f273",
      "name": "format AI output"
    },
    {
      "parameters": {
        "resource": "custom",
        "customResource": "res.partner",
        "operation": "getAll",
        "options": {
          "fieldsList": [
            "id",
            "name",
            "mobile"
          ]
        },
        "filterRequest": {
          "filter": [
            {
              "fieldName": "mobile",
              "operator": "like",
              "value": "={{ $json.phoneArray }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        5616,
        1008
      ],
      "id": "ec44321c-26da-4ed5-bc53-c91769371fd1",
      "name": "search for contact",
      "alwaysOutputData": true,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "odooApi": {
          "id": "0NgdIkIsJihhxK00",
          "name": "Dec 25 2025"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "phoneArray",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        5392,
        1008
      ],
      "id": "69a48fee-e517-4fed-b1b4-a9efeed562af",
      "name": "loop over each array component"
    },
    {
      "parameters": {
        "jsCode": "// ================= INPUT =================\nconst rawPhone = String($input.first().json['Phone Number'] || '');\nconst rawName  = String($input.first().json['Car Owner Name'] || '');\n\n// ================= 1Ô∏è‚É£ FORMAT NAME =================\nfunction capitalizeName(name) {\n  return name\n    .trim()\n    .split(/\\s+/)\n    .map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase())\n    .join(' ');\n}\n\nconst formattedName = capitalizeName(rawName);\n\n// ================= 2Ô∏è‚É£ FORMAT BASE PHONE (+20) =================\n// Keep digits only\nlet digits = rawPhone.replace(/\\D/g, '');\n\n// Normalize to Egyptian local 10 digits\nif (digits.startsWith('20')) digits = digits.slice(2);\nif (digits.startsWith('0'))  digits = digits.slice(1);\n\n// Safety check\nif (digits.length !== 10) {\n  throw new Error('Invalid Egyptian mobile number');\n}\n\n// Base phone number WITH country code\nconst formattedPhone = `+20${digits}`;\n\n// ================= 3Ô∏è‚É£ PHONE VARIATIONS =================\nconst p1 = digits.slice(0,3); // 100\nconst p2 = digits.slice(3,6); // 120\nconst p3 = digits.slice(6);   // 2986\n\nconst phoneArray = [\n  // Base & raw\n  digits,\n  `0${digits}`,\n  `20${digits}`,\n  `+20${digits}`,\n\n  // Spaced (most common)\n  `${p1} ${p2} ${p3}`,\n  `0${p1} ${p2} ${p3}`,\n  `20 ${p1} ${p2} ${p3}`,\n  `+20 ${p1} ${p2} ${p3}`,\n\n  // Semi-spaced\n  `${p1}${p2} ${p3}`,\n  `0${p1}${p2} ${p3}`,\n  `20${p1}${p2} ${p3}`,\n  `+20${p1}${p2} ${p3}`,\n\n  // Country code + continuous\n  `20 ${p1}${p2}${p3}`,\n  `+20 ${p1}${p2}${p3}`,\n\n  // Mixed spacing (real-world WhatsApp / CRM)\n  `+20 ${p1} ${p2}${p3}`,\n  `20 ${p1} ${p2}${p3}`,\n];\n\n// Remove duplicates\nconst uniquePhoneArray = [...new Set(phoneArray)];\n\n// ================= OUTPUT =================\nreturn [\n  {\n    json: {\n      formattedName,\n      formattedPhone,\n      phoneArray: uniquePhoneArray\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5168,
        1008
      ],
      "id": "a26811c4-2d0e-4963-bc0c-aef361072e90",
      "name": "format phone number"
    },
    {
      "parameters": {
        "jsCode": "// Get all 4 items from the \"search for contact\" node\nconst allItems = $input.all();\n\n// Check if there is at least one item, then return only the first one\nif (allItems.length > 0) {\n  return [allItems[0]]; \n}\n\n// If no items were found, return an empty array to stop the workflow\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5840,
        1008
      ],
      "id": "ffb08694-abbe-4496-b299-0f5691d961aa",
      "name": "return 1 item",
      "executeOnce": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "daad1ca4-2fc6-49dc-8167-d92981f4feda",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "c3db2dec-49d1-439f-a7bf-7f58200a3207",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6064,
        1008
      ],
      "id": "66c45904-fdfc-4018-b320-6d465350b8ba",
      "name": "If customer exists"
    },
    {
      "parameters": {
        "jsCode": "// 1. Get the data directly from the node that created the array\n// We use the exact name of the node from your screenshot\nconst inputData = $('format AI output').first().json;\nconst partNames = inputData.part_name;\n\n// 2. Error handling: if it's not an array, show a helpful message\nif (!Array.isArray(partNames)) {\n    return [{ json: { error: \"Could not find part_name array in 'format AI output' node\" } }];\n}\n\n// 3. Output ONLY the part names as individual items\nreturn partNames.map(name => {\n  return {\n    json: {\n      part: name\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5616,
        1440
      ],
      "id": "2bde873f-6042-4e96-8b2c-104d23d0fbb4",
      "name": "seperate parts"
    },
    {
      "parameters": {
        "jsCode": "// 1. Get ALL items coming from the previous node (Firestore Query)\nconst items = $input.all();\n\n// 2. If no items found, return empty to prevent workflow stop\nif (!items || items.length === 0) {\n  return [];\n}\n\n// 3. Extract the JSON data from each n8n item\nconst docs = items.map(item => item.json);\n\n// 4. Sort by Firestore _createTime ascending\ndocs.sort((a, b) => {\n  // Use the updateTime or createTime fields visible in your screenshot\n  const tA = new Date(a._createTime || a._updateTime).getTime();\n  const tB = new Date(b._createTime || b._updateTime).getTime();\n  return tA - tB;\n});\n\n// 5. Pick the newest one (the last element after sorting)\nconst newest = docs[docs.length - 1];\n\n// 6. Return as a single n8n item\nreturn [\n  {\n    json: newest\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5392,
        1440
      ],
      "id": "dee2c9db-54cb-4b2c-b8d9-393dde75b4ba",
      "name": "choose last qoutation"
    },
    {
      "parameters": {
        "operation": "query",
        "projectId": "automotiveagent-83ade",
        "query": "={   \"structuredQuery\": {     \"from\": [       {         \"collectionId\": \"quotes\"       }     ],     \"where\": {       \"compositeFilter\": {         \"op\": \"AND\",         \"filters\": [           {             \"fieldFilter\": {               \"field\": { \"fieldPath\": \"status\" },               \"op\": \"EQUAL\",               \"value\": { \"stringValue\": \"open\" }             }           },           {             \"fieldFilter\": {               \"field\": { \"fieldPath\": \"chat_id\" },               \"op\": \"EQUAL\",               \"value\": {                 \"integerValue\": \"{{ $('Add Global Variables').first().json.data.chat_id }}\"               }             }           }         ]       }     }   } }"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        5168,
        1440
      ],
      "id": "bfa449fb-0bf7-4f82-b40e-f29d14e137d1",
      "name": "Query all qoutations by chatId",
      "alwaysOutputData": false,
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "catalogResults",
        "columns": "=subgroups,type_code,series,model,engine,group_name"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        8432,
        1360
      ],
      "id": "53662d6e-2b9c-42ce-a6d3-df7eb3e46052",
      "name": "save group data",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// n8n Code Node ‚Äì Scraper ‚Üí Firestore Normalizer\n// Uses ONLY the first scraper object\n// Metadata sourced from correct upstream nodes\n// =====================================================\n\n// 1. Get ONLY the first item from scraper output\nconst firstItem = $input.all()[0]?.json;\n\nif (!firstItem || !Array.isArray(firstItem.subgroups)) {\n  return [{\n    json: {\n      error: \"Invalid scraper structure or missing subgroups\"\n    }\n  }];\n}\n\n// 2. Metadata (FROM CORRECT NODES)\n\n// From \"choose last qoutation\" node\nconst quotationNode = $('choose last qoutation').first()?.json;\n\nconst type_code = quotationNode?.vehicle_details?.type_code ?? null;\nconst series    = quotationNode?.vehicle_details?.series ?? null;\nconst model     = quotationNode?.vehicle_details?.model ?? null;\nconst engine    = quotationNode?.vehicle_details?.engine ?? null;\n\n// From \"prepare scraping\" node\nconst group_name = $('prepare scraping').first()?.json?.group_to_scrape ?? null;\n\n// 3. Normalize subgroups + parts (NOTES REMOVED)\nconst cleanSubgroups = firstItem.subgroups.map(sg => ({\n  subgroup: sg.subgroup || null,\n  diagram_image: sg.diagram_image || null,\n  parts: Array.isArray(sg.parts)\n    ? sg.parts.map(p => ({\n        item_no: p.item_no || null,\n        description: p.description || null,\n        supplement: p.supplement || null,\n        quantity: p.quantity || null,\n        from_date: p.from_date ?? null,\n        to_date: p.to_date ?? null,\n        part_number: p.part_number || null,\n        price: p.price || null\n        // notes intentionally omitted\n      }))\n    : []\n}));\n\n// 4. Return EXACTLY ONE Firestore-ready document\nreturn [\n  {\n    json: {\n      type_code,\n      series,\n      model,\n      engine,\n      group_name,\n      subgroups: cleanSubgroups\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8208,
        1360
      ],
      "id": "cfd4e181-8f2c-48a4-b75c-adcfce0c7990",
      "name": "prepare group data for firsetone",
      "alwaysOutputData": true,
      "executeOnce": false
    },
    {
      "parameters": {
        "chatId": "={{ $('Add Global Variables').item.json.data.chat_id }}",
        "text": "=ŸÅŸäŸá ÿπÿ±ÿ∂ ÿ≥ÿπÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅÿπŸÑÿßŸã ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿØŸä Ÿàÿ≠ÿßŸÑÿ™Ÿá ŸÑÿ≥Ÿá ŸÖŸÅÿ™Ÿàÿ≠ÿ©.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6736,
        640
      ],
      "id": "9205cb4f-6511-4027-8cae-51c8229136fa",
      "name": "Send a text message5",
      "webhookId": "63ee652a-f9e3-45a2-a4a6-5347ad9d5fff",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "query",
        "projectId": "automotiveagent-83ade",
        "query": "={  \"structuredQuery\": {     \"from\": [        {          \"collectionId\": \"quotes\"        }     ],     \"where\": {        \"compositeFilter\": {          \"op\": \"AND\",          \"filters\": [            {              \"fieldFilter\": {                \"field\": { \"fieldPath\": \"status\" },                \"op\": \"EQUAL\",                \"value\": { \"stringValue\": \"open\" }              }            },            {              \"fieldFilter\": {                \"field\": { \"fieldPath\": \"chat_id\" },                \"op\": \"EQUAL\",                \"value\": {                  \"integerValue\": \"{{ $('Add Global Variables').item.json.data.chat_id }}\"                }              }            },            {              \"fieldFilter\": {                \"field\": { \"fieldPath\": \"vin\" },                \"op\": \"EQUAL\",                \"value\": {                  \"stringValue\": \"{{ $('format AI output').item.json.vin }}\"                }              }            }          ]        }     }   } }"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        6288,
        688
      ],
      "id": "062c991f-825a-4004-a1c3-cbb2a3ed0368",
      "name": "Query all qoutations by chatId2",
      "alwaysOutputData": true,
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f0480249-f97d-45fb-baa6-07c0527897e6",
              "leftValue": "={{ $json }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7760,
        1504
      ],
      "id": "924784dd-52fc-47b1-9aeb-6f0e26fa373e",
      "name": "If1"
    },
    {
      "parameters": {
        "operation": "query",
        "projectId": "automotiveagent-83ade",
        "query": "={\n  \"structuredQuery\": {\n    \"from\": [\n      {\n        \"collectionId\": \"catalogResults\"\n      }\n    ],\n    \"where\": {\n      \"compositeFilter\": {\n        \"op\": \"AND\",\n        \"filters\": [\n          {\n            \"fieldFilter\": {\n              \"field\": {\n                \"fieldPath\": \"group_name\"\n              },\n              \"op\": \"EQUAL\",\n              \"value\": {\n                \"stringValue\": \"{{ $json.group_to_scrape }}\"\n              }\n            }\n          },\n          {\n            \"fieldFilter\": {\n              \"field\": {\n                \"fieldPath\": \"type_code\"\n              },\n              \"op\": \"EQUAL\",\n              \"value\": {\n                \"stringValue\": \"{{ $('choose last qoutation').first().json.vehicle_details.type_code }}\"\n              }\n            }\n          }\n        ]\n      }\n    }\n  }\n}\n"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        7536,
        1504
      ],
      "id": "eebd06c7-3567-40d8-96fc-2f06729a0210",
      "name": "Query by typecode and group",
      "alwaysOutputData": true,
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "589f44ce-511a-41d5-81b8-a476b6e4505f",
              "leftValue": "={{ $json }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6512,
        688
      ],
      "id": "874e73cc-348b-4529-8d03-2b23114761ab",
      "name": "If qoutation exists"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        2272
      ],
      "id": "9cee1475-1ef3-4271-8a1c-5a7e4bda1dfb",
      "name": "Database content"
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "binaryData": true,
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        9888,
        1632
      ],
      "id": "48a6f798-74b3-434b-9976-b4695a6cc734",
      "name": "Send a photo message",
      "webhookId": "34507aef-bd6d-4b3a-9978-9a9c48105073",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{ $('choose last qoutation').item.json._id }}/basket",
        "columns": "part_number,products"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        12128,
        1200
      ],
      "id": "82bc3771-7953-4c1a-96e0-b7c0e298170f",
      "name": "add to basket",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{ $('choose last qoutation').all()[0].json._id }}/basket"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        13472,
        1360
      ],
      "id": "f6e7a4d2-f5b0-4a16-8a11-bee09b14d64d",
      "name": "get basket items",
      "alwaysOutputData": true,
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    items: [\n      {\n        name: \"Engine Oil\",\n        products: [\n          \"5W-30 Synthetic\",\n          \"10W-40 Semi-Synthetic\",\n          \"Mineral Oil\"\n        ]\n      },\n      {\n        name: \"Brake Pads\",\n        products: [\n          \"Ceramic Pads\",\n          \"Semi-Metallic Pads\",\n          \"Organic Pads\"\n        ]\n      },\n      {\n        name: \"Tires\",\n        products: [\n          \"All-Season\",\n          \"Summer\",\n          \"Winter\"\n        ]\n      },\n      {\n        name: \"Battery\",\n        products: [\n          \"Standard Lead-Acid\",\n          \"AGM\",\n          \"Lithium\"\n        ]\n      }\n    ]\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        3392
      ],
      "id": "c2a00b12-472a-4a60-9c1c-076798d6bfbe",
      "name": "Code"
    },
    {
      "parameters": {
        "jsCode": "// Value we are comparing against\nconst targetPartNumber = $('Update State').first().json.part_number;\n\n// Default result\nlet isMatchFound = false;\n\n// Loop over all incoming items\nfor (const item of items) {\n  if (item.json.part_number === targetPartNumber) {\n    isMatchFound = true;\n    break; // Stop once a match is found\n  }\n}\n\n// Output ONE item with final boolean result\nreturn [\n  {\n    json: {\n      match: isMatchFound\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11680,
        1264
      ],
      "id": "771dd14c-583c-451e-befb-fead2eb3954c",
      "name": "item is already found in basket"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "61d4b850-d60d-4d05-9f10-5c2ae9fd7954",
              "leftValue": "={{ $json.match }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11904,
        1264
      ],
      "id": "7ef502fe-189e-4ed3-8437-4c650d70854c",
      "name": "item is  not found",
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "getAll",
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{ $('choose last qoutation').all()[0].json._id }}/basket"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        11456,
        1264
      ],
      "id": "f585303b-7243-438e-9a6e-76f046696838",
      "name": "Get basket items",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "resume": "webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        14144,
        1360
      ],
      "id": "631de68c-1aae-4663-8759-45c400e3cc04",
      "name": "Wait for product choosing",
      "webhookId": "06212d84-ed0a-419c-9a1b-53e37c57e240"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=<!DOCTYPE html>\n<html>\n<head>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Barlow+Condensed:wght@600;700;900&display=swap\" rel=\"stylesheet\">\n    <style>\n        :root {\n            --racing-red: #e60000;\n            --surface-glass: rgba(255, 255, 255, 0.04);\n            --border-light: rgba(255, 255, 255, 0.1);\n            --text-main: #ffffff;\n            --text-dim: #999999;\n        }\n\n        body { \n            font-family: 'Inter', sans-serif; \n            padding: 20px; \n            background-color: #080808;\n            background-image: \n                linear-gradient(45deg, #0d0d0d 25%, transparent 25%), \n                linear-gradient(-45deg, #0d0d0d 25%, transparent 25%), \n                linear-gradient(45deg, transparent 75%, #0d0d0d 75%), \n                linear-gradient(-45deg, transparent 75%, #0d0d0d 75%);\n            background-size: 8px 8px;\n            color: var(--text-main);\n            min-height: 100vh;\n        }\n\n        h3 { \n            font-family: 'Barlow Condensed', sans-serif;\n            text-transform: uppercase;\n            font-size: 2.2rem;\n            font-weight: 900;\n            letter-spacing: 2px;\n            margin-bottom: 40px;\n            border-bottom: 6px solid var(--racing-red);\n            display: inline-block;\n        }\n\n        .category-label {\n            font-family: 'Barlow Condensed', sans-serif;\n            font-size: 2.8rem;\n            font-weight: 900;\n            color: var(--text-main);\n            text-transform: uppercase;\n            letter-spacing: 1px;\n            margin: 50px 0 5px 0;\n            display: flex;\n            align-items: center;\n        }\n        \n        .item-part-id {\n            font-family: 'Inter', sans-serif;\n            font-size: 0.9rem;\n            color: var(--racing-red);\n            font-weight: 700;\n            margin-bottom: 20px;\n            display: block;\n            letter-spacing: 1px;\n            text-transform: uppercase;\n        }\n\n        .category-label::before {\n            content: \"\";\n            width: 12px;\n            height: 40px;\n            background: var(--racing-red);\n            margin-right: 15px;\n            display: inline-block;\n        }\n\n        .product-card { \n            background: var(--surface-glass);\n            backdrop-filter: blur(15px);\n            border: 1px solid var(--border-light);\n            border-radius: 4px;\n            margin-bottom: 12px; \n            transition: all 0.2s ease;\n            position: relative;\n        }\n\n        .product-label { \n            display: flex; \n            align-items: center; \n            padding: 25px; \n            cursor: pointer;\n        }\n\n        .product-card:hover {\n            background: rgba(255, 255, 255, 0.08);\n            border-color: var(--racing-red);\n        }\n\n        .product-card:has(input:checked) {\n            border-color: var(--racing-red);\n            background: rgba(230, 0, 0, 0.1);\n            box-shadow: 0 0 20px rgba(230, 0, 0, 0.2);\n        }\n\n        input[type=\"radio\"] { \n            appearance: none;\n            width: 24px; height: 24px; \n            border: 2px solid #444;\n            margin-right: 25px;\n            flex-shrink: 0;\n            background: #000;\n            position: relative;\n        }\n\n        input[type=\"radio\"]:checked {\n            background: var(--racing-red);\n            border-color: var(--racing-red);\n        }\n\n        input[type=\"radio\"]:checked::after {\n            content: \"‚úì\";\n            color: white;\n            font-size: 16px;\n            position: absolute;\n            top: 50%; left: 50%;\n            transform: translate(-50%, -50%);\n        }\n\n        .info-top { \n            font-size: 0.8rem; \n            color: var(--text-dim); \n            font-weight: 800; \n            text-transform: uppercase;\n            letter-spacing: 1px;\n            margin-bottom: 5px;\n        }\n\n        .name { \n            font-family: 'Barlow Condensed', sans-serif;\n            font-size: 1.6rem; \n            font-weight: 700; \n            color: #fff;\n            line-height: 1.1;\n        }\n\n        .price { \n            color: #fff; \n            font-weight: 800; \n            font-size: 1.3rem;\n            margin-top: 5px;\n            display: block;\n        }\n\n        .labor-box {\n            margin-top: 60px;\n            padding: 30px;\n            background: #111;\n            border: 2px solid var(--border-light);\n            border-left: 8px solid var(--racing-red);\n        }\n\n        input[type=\"number\"] { \n            width: 100%; \n            background: #000;\n            border: 1px solid #333;\n            color: var(--racing-red);\n            font-size: 2.5rem;\n            font-weight: 700;\n            padding: 15px;\n            outline: none;\n        }\n\n        button { \n            width: 100%; \n            padding: 25px; \n            background: var(--racing-red);\n            color: white; \n            border: none; \n            font-family: 'Barlow Condensed', sans-serif;\n            font-size: 1.5rem; \n            font-weight: 900; \n            margin-top: 30px; \n            cursor: pointer;\n            text-transform: uppercase;\n            letter-spacing: 3px;\n        }\n    </style>\n</head>\n<body>\n    <form action=\"{{ $execution.resumeUrl }}\" method=\"POST\" id=\"mainForm\">\n        <h3>SYSTEM_CONFIG // 2026</h3>\n\n        {{ \n            (() => {\n                // Track seen part numbers to prevent visual duplicates in the form\n                const seenPartNumbers = new Set();\n                \n                // 1. Get the source items for UI display\n                const displayItems = $('format items').item.json.items;\n                \n                // 2. Get basket items to retrieve Firestore _id\n                const basketItems = $('get basket items').all();\n\n                return displayItems\n                    .filter(item => {\n                        // REMOVE DUPLICATES: Only allow one section per part number\n                        if (seenPartNumbers.has(item.part_number)) return false;\n                        seenPartNumbers.add(item.part_number);\n                        return true;\n                    })\n                    .map(item => {\n                        // Match part to get the Firestore document _id\n                        const basketMatch = basketItems.find(b => b.json.part_number === item.part_number);\n                        const itemFirestoreId = basketMatch ? basketMatch.json._id : 'new_item';\n\n                        const firstProduct = item.products[0];\n                        const categoryName = firstProduct?.category?.name || 'COMPONENT';\n                        const partNumber = item.part_number || 'N/A';\n                        const products = item.products;\n\n                        if (products.length === 0) return '';\n\n                        return `\n                            <div class=\"category-label\">${categoryName}</div>\n                            <span class=\"item-part-id\">PART_REF: #${partNumber}</span>\n                            ${products.map(product => `\n                                <div class=\"product-card\" onclick=\"toggleRadio(this)\">\n                                    <label class=\"product-label\" onclick=\"event.preventDefault()\">\n                                        <input type=\"radio\" \n                                               name=\"item_${itemFirestoreId}\" \n                                               value=\"${product.id}\" \n                                               id=\"rad_${product.id}\">\n                                        <div>\n                                            <div class=\"info-top\">${product.brand?.name || 'OEM'} // QTY: ${product.qty_available || 0}</div>\n                                            <span class=\"name\">${product.name}</span>\n                                            <span class=\"price\">${Number(product.standard_price).toLocaleString()} EGP</span>\n                                        </div>\n                                    </label>\n                                </div>\n                            `).join('')}\n                        `;\n                    }).join('');\n            })()\n        }}\n\n        <div class=\"labor-box\">\n            <label style=\"font-weight:800; text-transform:uppercase; color:var(--text-dim); margin-bottom:10px; display:block;\">Service & Installation Labor</label>\n            <input type=\"number\" name=\"labor_cost\" placeholder=\"0\" required>\n        </div>\n\n        <button type=\"submit\">EXECUTE_DEPLOYMENT</button>\n    </form>\n\n    <script>\n        let lastChecked = {}; \n\n        function toggleRadio(card) {\n            const radio = card.querySelector('input[type=\"radio\"]');\n            const groupName = radio.name;\n\n            if (lastChecked[groupName] === radio) {\n                radio.checked = false;\n                lastChecked[groupName] = null;\n            } else {\n                radio.checked = true;\n                lastChecked[groupName] = radio;\n            }\n        }\n    </script>\n</body>\n</html>",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        14368,
        1360
      ],
      "id": "325b657c-9555-432e-b2c8-b20a0dd5bf13",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "resume": "webhook",
        "httpMethod": "POST",
        "options": {}
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        14592,
        1360
      ],
      "id": "b107b90f-936e-4205-9bce-39ef606fb3b1",
      "name": "Wait",
      "webhookId": "59b3d234-6418-46ed-8e29-e88e6ddc2aaa"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "text": "please choose products and add labor costs                                       ÿ™ÿ≠ÿ® ÿ™ÿ∂ŸäŸÅ ŸÖÿµŸÜÿπŸäÿ© ŸÇÿØ ÿ•ŸäŸáÿü                                         ",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "click  here ",
                    "additionalFields": {
                      "url": "={{ $execution.resumeUrl }}"
                    }
                  }
                ]
              }
            },
            {}
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        13920,
        1360
      ],
      "id": "80f6e607-d996-48dc-80ec-9e5f80efd3fa",
      "name": "labor cost to add && choose products",
      "webhookId": "04cd5ac6-4f53-4abd-ba02-c8e28ed37253",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/*\n INPUT:\n - this node receives multiple items (ex: 12)\n - each item is a basket document from Firestore\n\n OUTPUT:\n - ONE item\n - json.items = formatted basket array\n*/\n\nconst inputItems = items; // all incoming items\n\nconst formattedItems = [];\n\nfor (const item of inputItems) {\n  const data = item.json;\n\n  // Skip invalid basket entries\n  if (!data.part_number) continue;\n  if (!Array.isArray(data.products)) continue;\n  if (data.products.length === 0) continue;\n\n  // Normalize products\n  const products = data.products.map(p => ({\n    id: p.id,\n    name: p.name,\n    standard_price: p.standard_price,\n    qty_available: p.qty_available,\n    active: p.active,\n    x_studio_oen: p.x_studio_oen,\n    brand: Array.isArray(p.x_studio_product_brand)\n      ? {\n          id: p.x_studio_product_brand[0],\n          name: p.x_studio_product_brand[1]\n        }\n      : null,\n    category: Array.isArray(p.categ_id)\n      ? {\n          id: p.categ_id[0],\n          name: p.categ_id[1]\n        }\n      : null\n  }));\n\n  formattedItems.push({\n    part_number: data.part_number,\n    products\n  });\n}\n\n// ‚úÖ Return ONE item containing the array\nreturn [\n  {\n    json: {\n      items: formattedItems,\n      total_items: formattedItems.length\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13696,
        1360
      ],
      "id": "d390d637-19b0-4327-92f0-b76aa08e6c20",
      "name": "format items"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// Combined Code Node (basket doc id in key: item_<basketDocId>)\n// Output includes:\n// - quoteId, itemDocId, chosen_product_id\n// - selections[], totals\n// =====================================================\n\n// 1) Form submission\nconst submission = $json?.body ?? {};\nconst laborCost = Number.parseFloat(submission.labor_cost) || 0;\n\n// 2) Source items (from your \"format items\" node)\nconst sourceItems =\n  $items(\"format items\")[0]?.json?.items ??\n  $node[\"format items\"]?.json?.items ??\n  [];\n\nif (!Array.isArray(sourceItems)) {\n  throw new Error('Node \"format items\" must output { items: [...] }');\n}\n\n// 3) Build selections\nconst selections = [];\nlet totalPartsPrice = 0;\n\nfor (const key of Object.keys(submission)) {\n  if (!key.startsWith(\"item_\")) continue;\n\n  // basket document id from the key\n  const basketDocId = String(key.slice(\"item_\".length)).trim();\n  if (!basketDocId) continue; // skip bad key like \"item_\"\n\n  // chosen product id from submission value\n  const chosenProductIdRaw = submission[key];\n  if (chosenProductIdRaw == null || chosenProductIdRaw === \"\") continue;\n\n  // Find chosen product in sourceItems\n  let foundProduct = null;\n  for (const item of sourceItems) {\n    const products = Array.isArray(item?.products) ? item.products : [];\n    const match = products.find(p => String(p?.id) === String(chosenProductIdRaw));\n    if (match) {\n      foundProduct = match;\n      break;\n    }\n  }\n\n  if (!foundProduct) continue;\n\n  const productIdNum = Number(foundProduct.id);\n  if (!Number.isFinite(productIdNum)) {\n    throw new Error(`Invalid product id found in sourceItems: ${foundProduct.id}`);\n  }\n\n  const price = Number(foundProduct.standard_price) || 0;\n\n  selections.push({\n    // IMPORTANT: this is the basket document id\n    item_id: basketDocId,\n\n    // numeric product id\n    product_id: productIdNum,\n\n    product_name: foundProduct.name ?? null,\n    brand_name: foundProduct.brand?.name ?? null,\n    category_name: foundProduct.category?.name ?? null,\n    price,\n  });\n\n  totalPartsPrice += price;\n}\n\n// 4) Validate selections\nif (!Array.isArray(selections) || selections.length === 0) {\n  throw new Error(\"No selections were found in the submitted form data.\");\n}\n\n// 5) Prepare Firestore IDs (SAFE) from first selection + quote node\nconst first = selections[0];\n\nconst itemDocId = String(first.item_id ?? \"\").trim(); // basket doc id\nif (!itemDocId) {\n  throw new Error('Missing selections[0].item_id (would create basket/undefined)');\n}\n\nconst chosen_product_id = Number(first.product_id); // numeric\nif (!Number.isFinite(chosen_product_id)) {\n  throw new Error('Missing/invalid selections[0].product_id');\n}\n\nconst quoteId = String($items(\"choose last qoutation\")[0]?.json?._id ?? \"\").trim();\nif (!quoteId) {\n  throw new Error('Missing quoteId from node \"choose last qoutation\" (field _id)');\n}\n\n// 6) Return ONE n8n item\nreturn [\n  {\n    json: {\n      quoteId,\n      itemDocId,\n      chosen_product_id,\n\n      selections,\n      labor_cost: laborCost,\n      parts_total: totalPartsPrice,\n      grand_total: totalPartsPrice + laborCost,\n      items_selected_count: selections.length,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14816,
        1360
      ],
      "id": "0f19b4ea-e62c-456b-ba76-8ba7673fd15c",
      "name": "formats user output"
    },
    {
      "parameters": {
        "projectId": "automotiveagent-83ade",
        "collection": "=tenants",
        "documentId": "={{ $('Query ChatID').first().json.tenant_id }}"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        15040,
        1360
      ],
      "id": "93dc7f93-2044-4eb7-88fa-a52c36e9f25c",
      "name": "Get a tenant name",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{$json.quoteId}}/basket",
        "documentId": "={{$json.itemDocId}}"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -1376,
        368
      ],
      "id": "7248bfc1-bdb1-4ca9-92c1-c743e073dfc8",
      "name": "Get basket doc",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: $node[\"add chosen product id\"].json.data\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        368
      ],
      "id": "1072524d-7389-44fb-b453-a9e47ace5a5b",
      "name": "get basket data"
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{ $('add chosen product id').item.json.quoteId }}/basket",
        "documentId": "={{ $('add chosen product id').item.json._id }}",
        "columns": "part_number,products,chosen_product_id",
        "simple": false
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -480,
        368
      ],
      "id": "d08cca70-4388-4e38-b02a-7deb84340482",
      "name": "create new document in basket",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{$json.quoteId}}/basket",
        "documentId": "={{ $json._id }}"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        -928,
        368
      ],
      "id": "e5882769-8a9b-440a-99fa-e4a9b828138b",
      "name": "Delete the basket document",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "phoneNumberId": "804877562714688",
        "recipientPhoneNumber": "+201001202986",
        "template": "car_quot_request|ar_EG",
        "components": {
          "component": [
            {
              "bodyParameters": {
                "parameter": [
                  {
                    "text": "={{ $json.name }}"
                  },
                  {
                    "text": "={{ $json.car_model }}"
                  },
                  {
                    "text": "={{ $json.vin }}"
                  },
                  {
                    "text": "={{ $json.basket_text }}"
                  },
                  {
                    "text": "={{ $json.total }}"
                  },
                  {
                    "text": "={{ $json.esm_markaz_el_5edma }}"
                  },
                  {
                    "text": "={{ $json.labor_cost }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        15488,
        1360
      ],
      "id": "38c8cf0a-7d95-4ec1-8861-5e143cf40a40",
      "name": "Send template",
      "webhookId": "6b20e210-4687-4554-b038-a927e318ff68",
      "credentials": {
        "whatsAppApi": {
          "id": "UutrSfGKp22xKQOs",
          "name": "WhatsApp account 2"
        }
      }
    },
    {
      "parameters": {
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{ $('formats user output').item.json.quoteId }}/basket",
        "documentId": "={{ $('formats user output').item.json.itemDocId }}"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        15712,
        1456
      ],
      "id": "ee1cef77-1e0e-4e8d-b9b5-6fd232078d0d",
      "name": "Get basket doc1",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// Add wp_message_id AND chosen_product_id to existing basket documents\n// + Flatten WhatsApp payload from \"Send template\" node into individual fields\n// (one output item per basket doc)\n// =====================================================\n\n// Input docs from \"Get basket doc\" (may be 1 or many)\nconst docs = $input.all().map(i => i.json);\n\n// Combined node output (contains selections + quoteId)\nconst combined = $items(\"formats user output\")[0]?.json || {};\n\nconst quoteId = String(combined.quoteId ?? \"\").trim();\nif (!quoteId) {\n  throw new Error(\"Missing quoteId from node 'formats user output'\");\n}\n\nconst selections = combined.selections;\nif (!Array.isArray(selections) || selections.length === 0) {\n  throw new Error(\"formats user output has no selections array or it is empty\");\n}\n\n// Get WhatsApp payload (full output) from Send template node (not necessarily directly connected)\nconst sendTemplateItems = $items(\"Send template\");\nconst whatsapp_payload =\n  Array.isArray(sendTemplateItems) && sendTemplateItems.length > 0\n    ? sendTemplateItems[0].json\n    : null;\n\nif (!whatsapp_payload) {\n  throw new Error(\"Missing whatsapp_payload from node 'Send template'\");\n}\n\n// Extract key WhatsApp fields (flatten)\nconst messaging_product = String(whatsapp_payload?.messaging_product ?? \"\").trim();\nconst contacts = Array.isArray(whatsapp_payload?.contacts) ? whatsapp_payload.contacts : [];\nconst messages = Array.isArray(whatsapp_payload?.messages) ? whatsapp_payload.messages : [];\n\nconst contact_wa_id = String(contacts?.[0]?.wa_id ?? \"\").trim();\nconst contact_input = String(contacts?.[0]?.input ?? \"\").trim();\n\nconst wp_message_id = String(messages?.[0]?.id ?? \"\").trim();\nconst wp_message_status = String(messages?.[0]?.message_status ?? \"\").trim();\n\nif (!wp_message_id) {\n  throw new Error(\"Missing wp_message_id from node 'Send template'\");\n}\n\n// Helper: strip Firestore metadata\nfunction stripMeta(doc) {\n  if (!doc || typeof doc !== \"object\") return {};\n  const { _name, _createTime, _updateTime, _id, ...data } = doc;\n  return { _id, data };\n}\n\n// Build an output item per basket doc\nconst out = [];\n\nfor (const sel of selections) {\n  const itemDocId = String(sel.item_id ?? \"\").trim(); // basket doc id\n  if (!itemDocId) {\n    throw new Error(\"Missing selection.item_id (basket doc id)\");\n  }\n\n  // chosen product id from the SAME selections array\n  const chosen_product_id = Number(sel.product_id);\n  if (!Number.isFinite(chosen_product_id)) {\n    throw new Error(`Missing/invalid product_id for basket doc ${itemDocId}`);\n  }\n\n  // Find matching Firestore doc from input by _id\n  const matchingDoc = docs.find(d => String(d?._id) === itemDocId) || {};\n\n  // Strip metadata\n  const { _id, data } = stripMeta(matchingDoc);\n\n  // Add / overwrite fields\n  data.wp_message_id = wp_message_id;\n  data.chosen_product_id = chosen_product_id;\n\n  // Flattened WhatsApp payload fields (individual elements)\n  data.wp_messaging_product = messaging_product;\n  data.wp_contact_wa_id = contact_wa_id;\n  data.wp_contact_input = contact_input;\n  data.wp_message_status = wp_message_status;\n\n  out.push({\n    json: {\n      _id: _id || itemDocId,   // basket document id\n      quoteId,                 // quotes/<quoteId>/basket/<_id>\n      data,\n\n      // optional debug info\n      itemDocId,\n      wp_message_id,\n      chosen_product_id,\n      wp_messaging_product: messaging_product,\n      wp_contact_wa_id: contact_wa_id,\n      wp_contact_input: contact_input,\n      wp_message_status,\n    },\n  });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15936,
        1456
      ],
      "id": "3706a669-c648-4d90-acdc-153903fa82a2",
      "name": "add wp message id",
      "alwaysOutputData": true,
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "delete",
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{$json.quoteId}}/basket",
        "documentId": "={{ $json._id }}"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        16192,
        1392
      ],
      "id": "cbf7388d-e641-4564-bee5-5486b9954c99",
      "name": "Delete the basket document 2",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Input docs from \"Get basket doc\" (may be 1 or many)\nconst docs = $input.all().map(i => i.json);\n\n// Combined node output\nconst combined = $items(\"formats user output\")[0]?.json || {};\n\nconst quoteId = String(combined.quoteId ?? \"\").trim();\nif (!quoteId) {\n  throw new Error(\"Missing quoteId from node 'formats user output'\");\n}\n\nconst selections = combined.selections;\nif (!Array.isArray(selections) || selections.length === 0) {\n  throw new Error(\"formats user output has no selections array or it is empty\");\n}\n\n// Helper: strip Firestore metadata\nfunction stripMeta(doc) {\n  if (!doc || typeof doc !== \"object\") return {};\n  const { _name, _createTime, _updateTime, _id, ...data } = doc;\n  return { _id, data };\n}\n\n// Build an output item per selection (per basket doc)\nconst out = [];\n\nfor (const sel of selections) {\n  const itemDocId = String(sel.item_id ?? \"\").trim(); // basket doc id\n  if (!itemDocId) {\n    throw new Error(\"Missing selection.item_id (basket doc id)\");\n  }\n\n  const chosen_product_id = Number(sel.product_id);\n  if (!Number.isFinite(chosen_product_id)) {\n    throw new Error(`Missing/invalid product_id for basket doc ${itemDocId}`);\n  }\n\n  // Find matching Firestore doc from input by _id, fallback to empty object\n  const matchingDoc = docs.find(d => String(d?._id) === itemDocId) || {};\n\n  // Strip metadata and get data fields\n  const { _id, data } = stripMeta(matchingDoc);\n\n  // Add/update chosen_product_id\n  data.chosen_product_id = chosen_product_id;\n\n  // Return one item per basket doc\n  out.push({\n    json: {\n      _id: _id || itemDocId,  // ensure we always have the basket doc id\n      quoteId,\n      data,\n      // optional: keep some helpful info for debugging/logs\n      itemDocId,\n      chosen_product_id,\n    },\n  });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        368
      ],
      "id": "f84100f9-8c3a-4c87-9d2f-52f05ad1a9ba",
      "name": "add chosen product id"
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "=quotes/{{ $('add wp message id').item.json.quoteId }}/basket",
        "documentId": "={{ $('add wp message id').item.json._id }}",
        "columns": "part_number,products,chosen_product_id,labor_cost,total_cost",
        "simple": false
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        16608,
        1360
      ],
      "id": "dd325a07-0acd-45e9-a65f-3ecc638bfce4",
      "name": "create new basket with product id",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "54829cc1-393b-4e43-9a42-087ae5bd9f08",
              "leftValue": "={{ $json.add_more_items }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        12576,
        1264
      ],
      "id": "c804207a-8721-4d31-9ce8-0799860ec65b",
      "name": "If we are in last item"
    },
    {
      "parameters": {
        "operation": "create",
        "projectId": "automotiveagent-83ade",
        "collection": "messages",
        "documentId": "={{ $json.data.wp_message_id }}",
        "columns": "wp_message_id,wp_contact_wa_id,wp_contact_input,wp_message_status,wp_messaging_product,quoteId"
      },
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [
        16160,
        1552
      ],
      "id": "8f671bc3-bbd5-4bf0-b46a-2f543b84d947",
      "name": "add wp message content",
      "credentials": {
        "googleFirebaseCloudFirestoreOAuth2Api": {
          "id": "qAVGOUZ9Of6FhABN",
          "name": "Google Firebase Cloud Firestore account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1) Get basket items count from Firestore node\nconst basketItems = $items(\"Get basket items\");\nconst basketCount = Array.isArray(basketItems) ? basketItems.length : 0;\n\n// 2) Get part_name array from \"format AI output\" node\nconst formatItems = $items(\"format AI output\");\nconst firstFormatItem =\n  Array.isArray(formatItems) && formatItems.length > 0\n    ? formatItems[0].json\n    : {};\n\nconst partNames = firstFormatItem.part_name || [];\nconst partCount = Array.isArray(partNames) ? partNames.length : 0;\n\n// 3) SAME logic as before, ONLY name changed\nconst add_more_items = basketCount >= partCount;\n\n// 4) Return result\nreturn [\n  {\n    json: {\n      basket_items_count: basketCount,\n      part_name_count: partCount,\n      add_more_items\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12352,
        1264
      ],
      "id": "053bd2e8-147e-4a9f-a0f1-20185c20ed02",
      "name": "compare  basket count and parts count"
    },
    {
      "parameters": {
        "chatId": "={{ $(\"Telegram Trigger\").first().json.message.chat.id }}",
        "text": "please enter a correct vin",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4048,
        592
      ],
      "id": "61e59b3b-0ba8-4351-bfab-eee804dcca3c",
      "name": "Please Enter the correct vin",
      "webhookId": "40325931-4608-4e5c-9205-b27d7a986b47",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Normalize VIN Scraper output into { state, content }\n\nconst inputItems = $input.all();\nconst first = inputItems[0]?.json || {};\n\n// Detect error from HTTP node (Continue On Fail enabled)\nconst hasError =\n  first.error ||\n  first.status >= 400 ||\n  first.code === \"ERR_BAD_RESPONSE\";\n\n// ERROR CASE\nif (hasError) {\n  return [\n    {\n      json: {\n        state: \"error\",\n        content: \"error\"\n      }\n    }\n  ];\n}\n\n// SUCCESS CASE ‚Üí car content exactly as-is\nconst carContent =\n  inputItems.length === 1\n    ? inputItems[0].json\n    : inputItems.map(i => i.json);\n\nreturn [\n  {\n    json: {\n      state: \"car details\",\n      content: carContent\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        688
      ],
      "id": "3342ddc0-b7cd-4cd0-9734-8db48987dc9f",
      "name": "format scraper output"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f63d1d1e-42bd-4c60-9630-4936e50e7a35",
              "leftValue": "={{ $json.state }}",
              "rightValue": "error",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3760,
        688
      ],
      "id": "0a27bf17-c66d-4e48-9626-420dc19b435f",
      "name": "If vin exists"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1Q7qhfy34NvQPFpxLNGc2s8ANF0O929llb5fZx1zi0s4/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Q7qhfy34NvQPFpxLNGc2s8ANF0O929llb5fZx1zi0s4/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3248,
        1360
      ],
      "id": "2abc847a-635e-4ae9-a1b2-333b40e637e7",
      "name": "Get row(s) in sheet",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GQOyMlP0F8zR1D3O",
          "name": "Google Sheets account 4"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get all rows from Google Sheets\nconst rows = $input.all().map(i => i.json);\n\n// Get sessionId from the circled node\n// Replace the node name EXACTLY as it appears in your workflow\nconst sessionItems = $items(\"Set Plain Text\");\nconst sessionId = sessionItems?.[0]?.json?.sessionId ?? \"\";\n\n// Normalize and keep a consistent shape\nconst kits = rows\n  .filter(r => r && (r.kit_code || r.kit_name_ar || r.kit_name_en))\n  .map(r => ({\n    row_number: r.row_number ?? \"\",\n    kit_code: r.kit_code ?? \"\",\n    kit_name_ar: r.kit_name_ar ?? \"\",\n    kit_name_en: r.kit_name_en ?? \"\",\n    aliases: r.aliases ?? \"\",\n    category: r.category ?? \"\",\n    parts_list: r.parts_list ?? \"\",\n    notes: r.notes ?? \"\"\n  }));\n\n// Output ONE item containing all kits + sessionId\nreturn [\n  {\n    json: {\n      sessionId,\n      kits_count: kits.length,\n      kits\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        1360
      ],
      "id": "562f0e0d-f065-4536-a3a0-665e5bd534c3",
      "name": "format google sheets"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// n8n Code Node ‚Äì Normalize AI Kit Matching Output\n// Run Once for All Items\n// =====================================================\n\nconst root = $input.first().json || {};\n\n// -----------------------------------------------------\n// 1) Extract AI text from OpenAI / AI Agent envelope\n// -----------------------------------------------------\nlet text =\n  root?.output?.[0]?.content?.[0]?.text ??\n  root?.output?.[0]?.content?.[0]?.text?.value ??\n  \"\";\n\nif (typeof text !== \"string\" || !text.trim()) {\n  return [{\n    json: {\n      matched: false,\n      kit_code: \"\",\n      kit_name_ar: \"\",\n      kit_name_en: \"\",\n      confidence: \"low\",\n      parts_array: [],\n      clarify_message: \"ŸÖŸÅŸäÿ¥ ÿ±ÿØ Ÿàÿßÿ∂ÿ≠ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖÿå ÿ≠ÿßŸàŸÑ ÿ™ÿßŸÜŸä.\",\n      suggestions: []\n    }\n  }];\n}\n\n// -----------------------------------------------------\n// 2) Remove markdown fences if model added them\n// -----------------------------------------------------\nlet raw = text.trim()\n  .replace(/^```json\\s*/i, \"\")\n  .replace(/^```\\s*/i, \"\")\n  .replace(/```$/i, \"\")\n  .trim();\n\n// -----------------------------------------------------\n// 3) Handle DOUBLE-ESCAPED JSON STRING\n// Example: \"\\\"{\\\\\\\"output\\\\\\\":\\\\\\\"{...}\\\\\\\"}\\\"\"\n// -----------------------------------------------------\nif (raw.startsWith('\"')) {\n  try {\n    raw = JSON.parse(raw);\n  } catch (e) {\n    throw new Error(\n      \"AI returned quoted JSON but failed to unwrap. \" +\n      e.message +\n      \" | raw=\" +\n      raw.slice(0, 200)\n    );\n  }\n}\n\n// -----------------------------------------------------\n// 4) Parse OUTER JSON object\n// Expecting: { \"output\": \"<inner json string>\" } OR raw inner json\n// -----------------------------------------------------\nlet outer;\ntry {\n  outer = JSON.parse(raw);\n} catch (e) {\n  throw new Error(\n    \"AI text is not valid JSON object. \" +\n    e.message +\n    \" | raw=\" +\n    raw.slice(0, 200)\n  );\n}\n\n// -----------------------------------------------------\n// 5) Unwrap INNER JSON if wrapped in { output: \"...\" }\n// -----------------------------------------------------\nlet parsed = outer;\n\nif (outer && typeof outer === \"object\" && typeof outer.output === \"string\") {\n  try {\n    parsed = JSON.parse(outer.output);\n  } catch (e) {\n    throw new Error(\n      \"Wrapped AI output is not valid JSON. \" +\n      e.message +\n      \" | inner=\" +\n      outer.output.slice(0, 200)\n    );\n  }\n}\n\n// -----------------------------------------------------\n// 6) Normalize arrays safely (parts_array / suggestions)\n// -----------------------------------------------------\nlet partsArray = [];\nif (Array.isArray(parsed.parts_array)) {\n  partsArray = parsed.parts_array;\n} else if (typeof parsed.parts_array === \"string\" && parsed.parts_array.trim()) {\n  // in case model sends it as a JSON string\n  try {\n    const maybe = JSON.parse(parsed.parts_array);\n    if (Array.isArray(maybe)) partsArray = maybe;\n  } catch (_) {\n    // ignore, fallback empty\n  }\n}\n\nlet suggestionsArray = [];\nif (Array.isArray(parsed.suggestions)) {\n  suggestionsArray = parsed.suggestions;\n} else if (typeof parsed.suggestions === \"string\" && parsed.suggestions.trim()) {\n  try {\n    const maybe = JSON.parse(parsed.suggestions);\n    if (Array.isArray(maybe)) suggestionsArray = maybe;\n  } catch (_) {\n    // ignore\n  }\n}\n\n// -----------------------------------------------------\n// 7) Return FINAL SAFE STRUCTURE\n// -----------------------------------------------------\nconst confidence =\n  [\"high\", \"medium\", \"low\"].includes(String(parsed.confidence).toLowerCase())\n    ? String(parsed.confidence).toLowerCase()\n    : \"low\";\n\nreturn [{\n  json: {\n    matched: Boolean(parsed.matched),\n    kit_code: String(parsed.kit_code || \"\"),\n    kit_name_ar: String(parsed.kit_name_ar || \"\"),\n    kit_name_en: String(parsed.kit_name_en || \"\"),\n    confidence,\n    parts_array: partsArray.map(p => String(p).trim()).filter(Boolean),\n    clarify_message: String(parsed.clarify_message || \"\"),\n    suggestions: suggestionsArray.map(s => String(s).trim()).filter(Boolean)\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4048,
        1360
      ],
      "id": "f1d8a22b-e652-44a6-8e92-1aa40f5268f8",
      "name": "format ai output"
    },
    {
      "parameters": {
        "jsCode": "// 1) Get original user text that contains \"ÿ∑ŸÇŸÖ\"\nconst aiItems = $items(\"format AI output\");\nconst userText = (aiItems[0]?.json?.part_name?.[0] || \"\").toLowerCase();\n\n// 2) Get all kit rows from Google Sheets (previous node)\nconst rows = $input.all().map(i => i.json);\n\n// Helper: normalize text\nfunction norm(v) {\n  return String(v || \"\")\n    .toLowerCase()\n    .trim();\n}\n\n// 3) Try to find matching kit\nconst matchedKit = rows.find(row => {\n  const kitCode = norm(row.kit_code);\n  const nameAr = norm(row.kit_name_ar);\n  const nameEn = norm(row.kit_name_en);\n  const aliases = norm(row.aliases);\n\n  if (kitCode && userText.includes(kitCode)) return true;\n  if (nameAr && userText.includes(nameAr)) return true;\n  if (nameEn && userText.includes(nameEn)) return true;\n\n  if (aliases) {\n    return aliases.split(\",\").some(a => a && userText.includes(a.trim()));\n  }\n\n  return false;\n});\n\n// 4) If no kit matched\nif (!matchedKit) {\n  return [{\n    json: {\n      kit_found: false,\n      parts_array: [],\n      kit_row: {}\n    }\n  }];\n}\n\n// 5) Extract parts_list and convert to array\nconst rawParts = matchedKit.parts_list || \"\";\nconst partsArray = String(rawParts)\n  .split(\",\")\n  .map(p => p.trim())\n  .filter(Boolean);\n\n// 6) Output result\nreturn [{\n  json: {\n    kit_found: true,\n    parts_array: partsArray,\n    kit_row: matchedKit\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        -304
      ],
      "id": "0f15c26d-8b11-424f-a519-3ee65c51360f",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "88c22260-3511-42bf-be72-02f2f40ed248",
              "leftValue": "={{ $json.matched }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4272,
        1360
      ],
      "id": "33bda4f4-a12b-4d7d-b591-8fee62564a6f",
      "name": "If"
    },
    {
      "parameters": {
        "content": "do we need this create Quote on Db if we are creating one in other workflow"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        14000,
        624
      ],
      "typeVersion": 1,
      "id": "2f7b4f8c-266e-4db8-929c-1cbac6b52628",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "responses": {
          "values": [
            {
              "role": "system",
              "content": "HARD CONTRACT (must follow exactly):\n- Return ONLY ONE JSON object with exactly one key: \"output\".\n- \"output\" MUST be a STRING that contains valid JSON (no markdown, no backticks).\n- The outer response must look like:\n  {\"output\":\"{\\\"matched\\\":false,\\\"kit_code\\\":\\\"\\\",\\\"kit_name_ar\\\":\\\"\\\",\\\"kit_name_en\\\":\\\"\\\",\\\"confidence\\\":\\\"low\\\",\\\"parts_array\\\":[],\\\"clarify_message\\\":\\\"...\\\",\\\"suggestions\\\":[\\\"...\\\"]}\"}\n\nIMPORTANT:\n- Do NOT return the inner JSON directly. It must be inside the string.\n- Never add extra keys besides \"output\".\n\nTASK:\nYou will receive:\n1) user_input (Arabic or English)\n2) kits_json: array of kits. Each kit has:\n   - kit_code\n   - kit_name_ar\n   - kit_name_en\n   - aliases (comma-separated)\n   - category\n   - parts_list (comma-separated string)\n   - notes\n\nMATCH GATE (VERY IMPORTANT):\nSet matched=true ONLY if you have STRONG evidence the user meant this kit, defined as:\n- user_input clearly matches kit_name_ar OR kit_name_en OR an alias (exact or very close typo), OR\n- user_input contains a distinctive keyword that appears in that kit‚Äôs names/aliases and no other kit is similarly close.\n\nOtherwise you MUST set matched=false and confidence=\"low\".\nNever set confidence=\"high\" unless there is strong evidence.\n\nOutput JSON schema (always):\n{\n  \"matched\": true|false,\n  \"kit_code\": \"<string or empty>\",\n  \"kit_name_ar\": \"<string or empty>\",\n  \"kit_name_en\": \"<string or empty>\",\n  \"confidence\": \"<high|medium|low>\",\n  \"parts_array\": [\"part1\",\"part2\",...],\n  \"clarify_message\": \"<message in SAME language as user_input or empty>\",\n  \"suggestions\": [\"...\", \"...\", \"...\"]\n}\n\nCRITICAL LANGUAGE RULE (NO EXCEPTIONS):\nDetect the language of user_input FIRST.\n\n- If user_input is English (Latin letters):\n  - clarify_message MUST be in ENGLISH\n  - suggestions MUST be in ENGLISH ONLY\n  - NEVER output Arabic text anywhere in the response\n\n- If user_input is Arabic:\n  - clarify_message MUST be in ARABIC\n  - suggestions MUST be in ARABIC ONLY\n\nViolating this rule is considered an incorrect response.\n\nRules:\n\nWhen matched=false:\n- kit_code, kit_name_ar, kit_name_en must be \"\"\n- parts_array must be []\n- clarify_message must ask the user to clarify or choose, using the SAME language as user_input\n- suggestions must include 3 to 5 options ONLY from kits_json\n- suggestions must NEVER be random\n- suggestions must be the CLOSEST kit names by meaning or spelling to the misunderstood user_input\n- suggestions must ONLY contain KIT NAMES, never kit codes\n\nSuggestions language handling when matched=false:\n- If user_input is ARABIC:\n  - suggestions MUST contain ONLY kit_name_ar values from kits_json\n  - Do NOT translate to English\n\n- If user_input is ENGLISH:\n  - suggestions MUST be in ENGLISH ONLY\n  - For each suggested kit:\n    - Use kit_name_en if it exists and is not empty\n    - Otherwise translate kit_name_ar into clear, simple automotive English\n  - Do NOT include Arabic names\n  - Do NOT include kit codes\n\nWhen matched=true:\n- confidence must be \"high\" ONLY if the match is exact, alias-based, or a very close typo\n- confidence may be \"medium\" only if the semantic match is clear but not exact\n- parts_array must be derived ONLY by splitting parts_list by commas and trimming spaces\n- suggestions must be []\n\nNEVER invent a kit that is not in kits_json.\nNEVER invent parts that are not in parts_list.\n"
            },
            {
              "content": "=User input:\n{{ $items(\"format AI output\")[0].json.part_name[0] }}\n\nKits JSON:\n{{ JSON.stringify($items(\"format google sheets\")[0].json.kits) }}\n"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        3696,
        1360
      ],
      "id": "c4005153-b4fa-40fd-8c60-a57847861d0b",
      "name": "Message a model1",
      "credentials": {
        "openAiApi": {
          "id": "oxxlOcTwmUo3iwru",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $(\"Telegram Trigger\").first().json.message.from.id }}",
        "text": "=pleae clarify the type of kit you need . might these be one of them: {{ $(\"format ai output\").first().json.suggestions }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4496,
        1504
      ],
      "id": "2385a1de-4ffb-44d1-8873-3ffe579bed7f",
      "name": "Send a text message6",
      "webhookId": "6d674e6d-79dd-481c-8253-25bcb81e9d8b",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $(\"Telegram Trigger\").first().json.message.from.id }}",
        "message": "=are these the  {{ 'parts for ' + $(\"Set Plain Text\").first().json.userMessage + ' : ' + $json.parts_array.join(', ') }} ",
        "approvalOptions": {
          "values": {
            "approvalType": "double"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4496,
        1312
      ],
      "id": "a880bf97-3a51-4800-9fed-8545a76c31bf",
      "name": "Send message and wait for response kits",
      "webhookId": "c8483f12-4282-4031-babb-96dde4f4df0c",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $(\"Telegram Trigger\").first().json.message.from.id }}",
        "text": "please clarify what u need write parts individually",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4944,
        1440
      ],
      "id": "0cf2cab4-d307-49be-8f87-bc022bba6d11",
      "name": "Send a text message7",
      "webhookId": "dc7cb179-9342-4652-9d46-585d5c7edd67",
      "credentials": {
        "telegramApi": {
          "id": "qx5ajSiG1823Cd8i",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Take parts_array from \"format ai output\"\nconst partsArray = $('format ai output').first()?.json?.parts_array;\n\nif (!Array.isArray(partsArray)) {\n  throw new Error(\n    `parts_array is missing or not an array. Got: ${typeof partsArray}`\n  );\n}\n\n// Output: 1 n8n item per part\nreturn partsArray.map((part, index) => ({\n  json: {\n    part,              // the original part object/value\n    index,             // 0-based index\n    count: partsArray.length\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4944,
        1248
      ],
      "id": "bc2cd7d6-2486-425a-bb5b-b7fb30506dcd",
      "name": "send part in kit to scenario 1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3d6f3b81-00de-4fc4-9885-75cecb5442b5",
              "leftValue": "={{ $json.data.approved }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4720,
        1312
      ],
      "id": "143c39e0-c3e3-45d3-9bcf-0024a2935092",
      "name": "If3"
    },
    {
      "parameters": {
        "jsCode": "// Get data produced by \"add wp message id\"\nconst data = $node[\"add wp message id\"]?.json?.data ?? {};\n\n// Get totals from the code node \"Prepare whatsapp paramaters\"\nconst quotationCalc = $node[\"Prepare whatsapp paramaters\"]?.json ?? {};\n\n// Get selections from \"formats user output\"\nconst selections =\n  $items(\"formats user output\")?.[0]?.json?.selections ?? [];\n\n// Pull values safely\nconst labor_cost = Number(quotationCalc.labor_cost ?? 0);\nconst total_cost = Number(quotationCalc.total ?? 0);\n\nreturn [\n  {\n    json: {\n      ...data,\n      labor_cost,\n      total_cost,\n      selections\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16384,
        1360
      ],
      "id": "be60347e-a88c-4bfc-982d-b6db8fe90aaf",
      "name": "format basket conetnt"
    },
    {
      "parameters": {
        "url": "={{ 'https://api.scraperapi.com/?api_key=9c6e1643421d3d169797e0f21b348e88&url=' + encodeURIComponent(($json.message?.content?.diagram_url || $json.diagram_url || '').replace('http://','https://')) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        9456,
        1488
      ],
      "id": "cd901a0b-f8eb-4670-b9ed-45a374d3432d",
      "name": "get picture of item"
    }
  ],
  "pinData": {
    "Code in JavaScript": [
      {
        "json": {
          "basket_items_count": 5,
          "part_name_count": 1,
          "add_more_items": true
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Telegram Trigger": [
      {
        "json": {
          "update_id": 482147710,
          "message": {
            "message_id": 1942,
            "from": {
              "id": 8558973985,
              "is_bot": false,
              "first_name": "Youssef",
              "last_name": "Ezzat",
              "language_code": "en"
            },
            "chat": {
              "id": 8558973985,
              "first_name": "Youssef",
              "last_name": "Ezzat",
              "type": "private"
            },
            "date": 1770234985,
            "text": "oil filter"
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Query ChatID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Photo?": {
      "main": [
        [
          {
            "node": "Download Picture",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Plain Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Picture": {
      "main": [
        [
          {
            "node": "ocr.space",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Plain Text": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "format AI output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "get_vehicle_info": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "State Exists?": {
      "main": [
        [
          {
            "node": "Parse State",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Query Chat ID in Existing Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "VIN Scraper (HTTP)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Query all qoutations by chatId",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ocr.space": {
      "main": [
        [
          {
            "node": "Set OCR Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Hot Item (Google Sheets)": {
      "main": [
        [
          {
            "node": "Found in Hot Items?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Found in Hot Items?": {
      "main": [
        [
          {
            "node": "Direct Lookup by Part (HTTP B)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Alias Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Direct Lookup by Part (HTTP B)": {
      "main": [
        [
          {
            "node": "Did Scraper output a result?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VIN Scraper (HTTP)": {
      "main": [
        [
          {
            "node": "format scraper output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "prepare scraping",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scrape Realoem (HTTP A)": {
      "main": [
        [
          {
            "node": "prepare group data for firsetone",
            "type": "main",
            "index": 0
          },
          {
            "node": "Compare Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "evaluate scraper results": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Router": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Global Variables": {
      "main": [
        [
          {
            "node": "If Photo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a quotation": {
      "main": [
        [
          {
            "node": "Prepare Updated State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse State": {
      "main": [
        [
          {
            "node": "Add Global Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Initial State": {
      "main": [
        [
          {
            "node": "Create Chat Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Updated State": {
      "main": [
        [
          {
            "node": "Create Quotation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set OCR Text": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resolve_part": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search x_car": {
      "main": [
        [
          {
            "node": "x_car Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "x_car Exists?": {
      "main": [
        [
          {
            "node": "customer exists?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create a new car",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a new car": {
      "main": [
        [
          {
            "node": "Open Customer Form",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Did Scraper output a result?": {
      "main": [
        [
          {
            "node": "normalize input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update State": {
      "main": [
        [
          {
            "node": "Get basket items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Add more mesage": {
      "main": [
        [
          {
            "node": "Ask if want to add more items?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search for item": {
      "main": [
        [
          {
            "node": "if in stock?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compare Results": {
      "main": [
        [
          {
            "node": "early exit?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alias Map": {
      "main": [
        [
          {
            "node": "Search if word is in aliases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if found in alias map?": {
      "main": [
        [
          {
            "node": "prepare scraping",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "early exit?": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "evaluate scraper results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "if gpt decided it is one of them?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update alias map?": {
      "main": [
        []
      ]
    },
    "Search if word is in aliases": {
      "main": [
        [
          {
            "node": "if found in alias map?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare scraping": {
      "main": [
        [
          {
            "node": "Query by typecode and group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "confirm from user": {
      "main": [
        [
          {
            "node": "If approved?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ask if want to add more items?": {
      "main": [
        [
          {
            "node": "Will Add More Items?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If approved?1": {
      "main": [
        [
          {
            "node": "update alias map?",
            "type": "main",
            "index": 0
          },
          {
            "node": "normalize input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Will Add More Items?": {
      "main": [
        [
          {
            "node": "Please Enter the new items name",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get basket items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Quote Data For DB": {
      "main": [
        [
          {
            "node": "Notify Service Advisor about Message Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Open Customer Form": {
      "main": [
        [
          {
            "node": "Wait for Customer Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Customer Data": {
      "main": [
        [
          {
            "node": "format phone number",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Customer": {
      "main": [
        [
          {
            "node": "update partner id in car",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Chat ID in Existing Users": {
      "main": [
        [
          {
            "node": "Found existing user?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Found existing user?": {
      "main": [
        [
          {
            "node": "Pull Tenant Info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Block User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pull Tenant Info": {
      "main": [
        [
          {
            "node": "Is Tenant Active?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Tenant Active?": {
      "main": [
        [
          {
            "node": "Create Initial State",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Block User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if gpt decided it is one of them?": {
      "main": [
        [
          {
            "node": "get picture of item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message2": {
      "main": [
        []
      ]
    },
    "if in stock?": {
      "main": [
        [
          {
            "node": "Update State",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "normalize input": {
      "main": [
        [
          {
            "node": "Search for item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare whatsapp paramaters": {
      "main": [
        [
          {
            "node": "Send template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Subgroup for DB": {
      "main": [
        [
          {
            "node": "Save Scraped Subgroup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message4": {
      "main": [
        [
          {
            "node": "Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update partner id in car": {
      "main": [
        [
          {
            "node": "Create a quotation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query ChatID": {
      "main": [
        [
          {
            "node": "State Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Chat Record": {
      "main": [
        [
          {
            "node": "Add Global Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Quotation": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "customer exists?": {
      "main": [
        [
          {
            "node": "Query all qoutations by chatId2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Open Customer Form",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a new car1": {
      "main": [
        []
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        []
      ]
    },
    "format AI output": {
      "main": [
        [
          {
            "node": "Send a text message4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "search for contact": {
      "main": [
        [
          {
            "node": "return 1 item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "loop over each array component": {
      "main": [
        [
          {
            "node": "search for contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format phone number": {
      "main": [
        [
          {
            "node": "loop over each array component",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "return 1 item": {
      "main": [
        [
          {
            "node": "If customer exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If customer exists": {
      "main": [
        [
          {
            "node": "update partner id in car",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "seperate parts": {
      "main": [
        [
          {
            "node": "Check Hot Item (Google Sheets)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "choose last qoutation": {
      "main": [
        [
          {
            "node": "seperate parts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query all qoutations by chatId": {
      "main": [
        [
          {
            "node": "choose last qoutation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save group data": {
      "main": [
        []
      ]
    },
    "prepare group data for firsetone": {
      "main": [
        [
          {
            "node": "save group data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query all qoutations by chatId2": {
      "main": [
        [
          {
            "node": "If qoutation exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Scrape Realoem (HTTP A)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Compare Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query by typecode and group": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If qoutation exists": {
      "main": [
        [
          {
            "node": "Send a text message5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create a quotation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Database content": {
      "main": [
        []
      ]
    },
    "Send a photo message": {
      "main": [
        [
          {
            "node": "confirm from user",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "add to basket": {
      "main": [
        [
          {
            "node": "compare  basket count and parts count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get basket items": {
      "main": [
        [
          {
            "node": "format items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "item is already found in basket": {
      "main": [
        [
          {
            "node": "item is  not found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "item is  not found": {
      "main": [
        [
          {
            "node": "add to basket",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "compare  basket count and parts count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get basket items": {
      "main": [
        [
          {
            "node": "item is already found in basket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for product choosing": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "labor cost to add && choose products": {
      "main": [
        [
          {
            "node": "Wait for product choosing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "formats user output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format items": {
      "main": [
        [
          {
            "node": "labor cost to add && choose products",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formats user output": {
      "main": [
        [
          {
            "node": "Get a tenant name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a tenant name": {
      "main": [
        [
          {
            "node": "Prepare whatsapp paramaters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get basket doc": {
      "main": [
        [
          {
            "node": "add chosen product id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get basket data": {
      "main": [
        [
          {
            "node": "create new document in basket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete the basket document": {
      "main": [
        [
          {
            "node": "get basket data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send template": {
      "main": [
        [
          {
            "node": "Get basket doc1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Quote Data For DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get basket doc1": {
      "main": [
        [
          {
            "node": "add wp message id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "add wp message id": {
      "main": [
        [
          {
            "node": "add wp message content",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete the basket document 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete the basket document 2": {
      "main": [
        [
          {
            "node": "format basket conetnt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "add chosen product id": {
      "main": [
        [
          {
            "node": "Delete the basket document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create new basket with product id": {
      "main": [
        []
      ]
    },
    "If we are in last item": {
      "main": [
        [
          {
            "node": "Prepare Add more mesage",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "compare  basket count and parts count": {
      "main": [
        [
          {
            "node": "If we are in last item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format scraper output": {
      "main": [
        [
          {
            "node": "If vin exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If vin exists": {
      "main": [
        [
          {
            "node": "Please Enter the correct vin",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Search x_car",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "format google sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format google sheets": {
      "main": [
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format ai output": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "format ai output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Send message and wait for response kits",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message and wait for response kits": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send part in kit to scenario 1": {
      "main": [
        [
          {
            "node": "Query all qoutations by chatId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "send part in kit to scenario 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format basket conetnt": {
      "main": [
        [
          {
            "node": "create new basket with product id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get picture of item": {
      "main": [
        [
          {
            "node": "Send a photo message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "99d01b82-df97-4767-8004-6e124558f2b3",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "7d936f9023d9d95c59593b24e4eb79b74a72adef06bd5ea4670b2f67e357e602"
  },
  "id": "tSflSfTThib8agor",
  "tags": []
}